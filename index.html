<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organizador de Gastos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        * { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; }
        body { -webkit-font-smoothing: antialiased; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideInRight { from { opacity: 0; transform: translateX(12px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.03); } }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInFromRight { from { opacity: 0; transform: translateX(100%) scale(0.8); } to { opacity: 1; transform: translateX(0) scale(1); } }
        @keyframes slideOutToRight { from { opacity: 1; transform: translateX(0) scale(1); } to { opacity: 0; transform: translateX(100%) scale(0.8); } }
        @keyframes floatBubble { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        @keyframes badgePopIn { 0% { opacity: 0; transform: scale(0) rotate(-10deg); } 50% { transform: scale(1.2) rotate(5deg); } 100% { opacity: 1; transform: scale(1) rotate(0); } }
        @keyframes badgeShine { 0% { left: -100%; } 100% { left: 200%; } }
        @keyframes iconBounce { 0%, 100% { transform: translateY(0); } 25% { transform: translateY(-3px) rotate(-5deg); } 75% { transform: translateY(-3px) rotate(5deg); } }
        .animate-slide-in { animation: slideIn 0.25s ease-out; }
        .animate-slide-in-right { animation: slideInRight 0.25s ease-out; }
        .animate-pulse-once { animation: pulse 0.4s ease-in-out; }
        .animate-fade-in { animation: fadeIn 0.25s ease-out; }
        .progress-bar { transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.3s; }
        .motivation-toast { position: fixed; bottom: 24px; right: 24px; z-index: 100; max-width: 320px; animation: slideInFromRight 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), floatBubble 3s ease-in-out infinite 0.4s; }
        .motivation-toast.hiding { animation: slideOutToRight 0.3s ease-in forwards; }
        .motivation-toast-content { background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%); border: 1px solid #bae6fd; border-radius: 16px; padding: 16px 20px; box-shadow: 0 10px 40px rgba(59, 130, 246, 0.15); position: relative; overflow: hidden; }
        .motivation-toast-content::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, #3b82f6, #06b6d4, #3b82f6); background-size: 200% 100%; animation: shimmer 2s linear infinite; }
        .motivation-toast .close-btn { position: absolute; top: 8px; right: 8px; width: 20px; height: 20px; border-radius: 50%; background: #f1f5f9; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #64748b; transition: all 0.2s; }
        .motivation-toast .close-btn:hover { background: #e2e8f0; color: #334155; }
        .motivation-toast .progress-bar-toast { position: absolute; bottom: 0; left: 0; height: 3px; background: linear-gradient(90deg, #3b82f6, #06b6d4); border-radius: 0 0 16px 16px; transition: width 0.1s linear; }
        .badge-item { position: relative; display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; background: white; border: 1px solid #e2e8f0; border-radius: 16px; font-size: 0.7rem; font-weight: 500; color: #475569; cursor: default; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); overflow: hidden; opacity: 0; animation: badgePopIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        .badge-item:nth-child(1) { animation-delay: 0.1s; } .badge-item:nth-child(2) { animation-delay: 0.15s; } .badge-item:nth-child(3) { animation-delay: 0.2s; }
        .badge-item::before { content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent); }
        .badge-item:hover::before { animation: badgeShine 0.6s ease-out; }
        .badge-item:hover { transform: translateY(-2px) scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-color: #fbbf24; background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); }
        .badge-item .badge-icon { font-size: 0.85rem; transition: transform 0.3s; }
        .badge-item:hover .badge-icon { animation: iconBounce 0.5s ease-in-out; }
        .badge-tooltip { position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%) translateY(-8px); padding: 6px 10px; background: #1e293b; color: white; font-size: 0.6rem; border-radius: 6px; white-space: nowrap; opacity: 0; visibility: hidden; transition: all 0.2s; z-index: 10; }
        .badge-tooltip::after { content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); border: 4px solid transparent; border-top-color: #1e293b; }
        .badge-item:hover .badge-tooltip { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(-4px); }
        .gradient-bg { background: linear-gradient(135deg, #f0f4f8 0%, #e2e8f0 50%, #f0f4f8 100%); min-height: 100vh; }
        body.dark-mode { background: #0f172a !important; color: #e2e8f0; }
        body.dark-mode .bg-white { background-color: #1e293b !important; color: #e2e8f0; }
        body.dark-mode .text-gray-800 { color: #f1f5f9 !important; }
        body.dark-mode .text-gray-600 { color: #94a3b8 !important; }
        body.dark-mode .text-gray-500 { color: #64748b !important; }
        body.dark-mode .border-gray-300 { border-color: #334155 !important; }
        body.dark-mode input, body.dark-mode select { background-color: #0f172a !important; color: #e2e8f0 !important; border-color: #334155 !important; }
        body.dark-mode .bg-gray-50 { background-color: #1e293b !important; }
        body.dark-mode .gradient-bg { background: #0f172a; }
        body.dark-mode .total-card { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); }
        body.dark-mode .card { background: #1e293b; border: 1px solid #334155; }
        body.dark-mode #detailModal > div { background: #1e293b; }
        body.dark-mode #detailModal h3, body.dark-mode #detailModal .text-gray-800 { color: #e2e8f0; }
        body.dark-mode #detailModal .bg-gray-50 { background: #0f172a; }
        body.dark-mode #detailModal .bg-gray-100 { background: #334155; }
        body.dark-mode .badge-item { background: #1e293b; border-color: #334155; color: #e2e8f0; }
        body.dark-mode .badge-item:hover { background: linear-gradient(135deg, #422006 0%, #78350f 100%); border-color: #fbbf24; }
        body.dark-mode .motivation-toast-content { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-color: #334155; }
        body.dark-mode .motivation-toast-content p { color: #e2e8f0; }
        body.dark-mode .header-card { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); }
        body.dark-mode .income-card { background: #0f172a; border-color: #334155; }
        .time-filter { background: white; border: 1px solid #e2e8f0; transition: all 0.2s ease; }
        .time-filter:hover { background: #f1f5f9; border-color: #cbd5e1; }
        .time-filter-active { background: #3b82f6 !important; border-color: #3b82f6 !important; color: white !important; font-weight: 600; }
        .card { transition: all 0.2s ease; background: white; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
        .card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
        .header-card { background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border: 1px solid #e2e8f0; }
        .income-card { background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 12px 16px; transition: all 0.2s; }
        .income-card:hover { border-color: #3b82f6; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1); }
        .income-card:focus-within { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .income-card input { border: none !important; padding: 0 !important; background: transparent !important; font-size: 1.125rem; font-weight: 600; color: #1e293b; }
        .income-card input:focus { outline: none !important; box-shadow: none !important; }
        .income-card input::placeholder { color: #94a3b8; font-weight: 400; }
        .total-card { background: white; border: 1px solid #e2e8f0; transition: all 0.2s ease; min-width: 0; overflow: hidden; }
        .total-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .amount-display { font-size: clamp(0.875rem, 2.5vw, 1.25rem); line-height: 1.3; word-break: break-word; overflow-wrap: break-word; font-weight: 700; letter-spacing: -0.02em; }
        .amount-display-large { font-size: clamp(1.125rem, 3vw, 1.5rem); line-height: 1.3; word-break: break-word; overflow-wrap: break-word; font-weight: 700; letter-spacing: -0.02em; }
        .totals-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 0.75rem; }
        @media (min-width: 768px) { .totals-grid { grid-template-columns: repeat(7, 1fr); } }
        @media (max-width: 1200px) { .totals-grid { grid-template-columns: repeat(4, 1fr); } }
        @media (max-width: 768px) { .totals-grid { grid-template-columns: repeat(2, 1fr); } .motivation-toast { right: 12px; left: 12px; max-width: none; } }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.25s ease-out; }
        .collapsible-content.open { max-height: 600px; overflow-y: auto; }
        .toggle-btn { transition: transform 0.2s ease; color: #64748b; }
        .toggle-btn.open { transform: rotate(180deg); }
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .expense-item { transition: all 0.15s ease; background: #fafafa; border: 1px solid transparent; }
        .expense-item:hover { background: #f0f9ff; border-color: #bae6fd; }
        .connection-status { display: inline-flex; align-items: center; gap: 0.375rem; padding: 0.25rem 0.625rem; border-radius: 9999px; font-size: 0.65rem; font-weight: 500; }
        .connection-status.online { background: #dcfce7; color: #166534; }
        .connection-status.offline { background: #fee2e2; color: #991b1b; }
        .connection-dot { width: 5px; height: 5px; border-radius: 50%; }
        .connection-dot.online { background: #22c55e; }
        .connection-dot.offline { background: #ef4444; }
        .action-btn { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-size: 1rem; flex-shrink: 0; }
        .action-btn:hover { transform: translateY(-2px); }
        input, select { font-size: 0.875rem; box-sizing: border-box; }
        input:focus, select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        input[type="date"] { -webkit-appearance: none; min-width: 0 !important; max-width: 100% !important; width: 100% !important; box-sizing: border-box !important; }
        .grid { max-width: 100%; }
        .grid > * { min-width: 0; max-width: 100%; }
        button { font-weight: 500; }
        .using-savings-indicator { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 1px solid #f59e0b; animation: pulse 2s ease-in-out infinite; }
        .fixed-expense-badge { background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border: 1px solid #93c5fd; }
        .fixed-expense-badge:hover { border-color: #3b82f6; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15); }
        .savings-history-item { background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 1px solid #86efac; }
    </style>
</head>
<body class="min-h-screen gradient-bg">
    <div id="motivationToasts"></div>
    <div id="app" class="p-4 max-w-7xl mx-auto"></div>
    <script>
        const SUPABASE_CONFIG = {
            url: 'https://zdbpzndvuqtfemkfjman.supabase.co',
            anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpkYnB6bmR2dXF0ZmVta2ZqbWFuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MDI2MTEsImV4cCI6MjA4MjA3ODYxMX0.2Wb2mhplCe0DQtLOM3jNDVTUFyz1qAiFOag1loP2e8g',
            initialized: false
        };
        let supabaseClient = null, currentUser = null, isOnline = false, syncQueue = [], shownMotivations = new Set();
        let saveTimeout = null;
        let authState = { isAuthenticated: false, user: null, loading: true, authView: 'login', email: '', password: '', confirmPassword: '', authError: '', authSuccess: '' };
        let state = {
            expenses: [], savingsWithdrawals: [], savingsDeposits: [], debtors: [], loans: [], 
            fixedExpenses: [], savingsHistory: [],
            monthlyIncome: '', creditCardIncome: '', owedMoney: '', projectionMonths: '', monthlySavingsPlan: '',
            description: '', amount: '', category: 'üçé Alimentaci√≥n', date: new Date().toISOString().split('T')[0],
            withdrawalDescription: '', withdrawalAmount: '', depositDescription: '', depositAmount: '',
            debtorName: '', debtorAmount: '', loanName: '', loanAmount: '', loanMonths: '', loanPaid: '', loanStartDate: '',
            fixedExpenseName: '', fixedExpenseAmount: '',
            editingExpenseId: null, editingFixedExpenseId: null, darkMode: false, timeFilter: 'month', badges: [], lastMonthSavings: 0,
            showSavingsSection: false, showDebtorsSection: false, showProjectionsSection: false, showLoansSection: false, showFixedExpensesSection: false,
            userId: null, lastSync: null
        };
        const categories = [
            { name: 'üçé Alimentaci√≥n', displayName: 'Alimentaci√≥n', type: 'esencial' },
            { name: 'üöó Transporte', displayName: 'Transporte', type: 'esencial' },
            { name: 'üè† Vivienda', displayName: 'Vivienda', type: 'esencial' },
            { name: 'üíä Salud', displayName: 'Salud', type: 'esencial' },
            { name: 'üìö Educaci√≥n', displayName: 'Educaci√≥n', type: 'esencial' },
            { name: 'üéÆ Entretenimiento', displayName: 'Entretenimiento', type: 'salida' },
            { name: 'üçï Restaurantes', displayName: 'Restaurantes', type: 'salida' },
            { name: 'üõçÔ∏è Compras', displayName: 'Compras', type: 'salida' },
            { name: '‚úàÔ∏è Viajes', displayName: 'Viajes', type: 'salida' },
            { name: 'üí∞ Ahorro', displayName: 'Ahorro', type: 'ahorro' },
            { name: 'üìà Inversiones', displayName: 'Inversiones', type: 'ahorro' },
            { name: 'üí∏ Bizum', displayName: 'Bizum', type: 'bizum' },
            { name: 'üîÑ Suscripciones', displayName: 'Suscripciones', type: 'suscripcion' },
            { name: 'üì¶ Otros Gastos', displayName: 'Otros Gastos', type: 'otros' },
            { name: 'üîß Varios', displayName: 'Varios', type: 'otros' }
        ];
        const categoryColors = {
            'üçé Alimentaci√≥n': 'bg-green-100 text-green-800', 'üöó Transporte': 'bg-blue-100 text-blue-800',
            'üè† Vivienda': 'bg-purple-100 text-purple-800', 'üéÆ Entretenimiento': 'bg-pink-100 text-pink-800',
            'üíä Salud': 'bg-red-100 text-red-800', 'üìö Educaci√≥n': 'bg-yellow-100 text-yellow-800',
            'üçï Restaurantes': 'bg-orange-100 text-orange-800', 'üõçÔ∏è Compras': 'bg-fuchsia-100 text-fuchsia-800',
            '‚úàÔ∏è Viajes': 'bg-cyan-100 text-cyan-800', 'üí∞ Ahorro': 'bg-emerald-100 text-emerald-800',
            'üìà Inversiones': 'bg-teal-100 text-teal-800', 'üí∏ Bizum': 'bg-indigo-100 text-indigo-800',
            'üîÑ Suscripciones': 'bg-violet-100 text-violet-800', 'üì¶ Otros Gastos': 'bg-gray-100 text-gray-800',
            'üîß Varios': 'bg-slate-100 text-slate-800'
        };
        const badgeDefinitions = [
            { id: 'first_saving', name: 'Primer Ahorro', icon: 'üå±', description: 'Registraste tu primer ahorro', condition: () => getTotalByType().ahorro > 0 },
            { id: 'save_100', name: 'Ahorrador Novato', icon: 'üíµ', description: 'Ahorraste m√°s de 100‚Ç¨', condition: () => getTotalByType().ahorro >= 100 },
            { id: 'save_500', name: 'Ahorrador Experto', icon: 'üíé', description: 'Ahorraste m√°s de 500‚Ç¨', condition: () => getTotalByType().ahorro >= 500 },
            { id: 'save_1000', name: 'Maestro del Ahorro', icon: 'üëë', description: 'Ahorraste m√°s de 1000‚Ç¨', condition: () => getTotalByType().ahorro >= 1000 },
            { id: 'positive_balance', name: 'Balance Positivo', icon: '‚úÖ', description: 'Tu saldo es positivo', condition: () => getBalanceInfo().displayBalance > 0 },
            { id: 'no_luxury_3days', name: '3 D√≠as Sin Caprichos', icon: 'üéØ', description: '3 d√≠as sin gastos innecesarios', condition: () => checkNoDaysNoLuxury(3) },
            { id: 'month_complete', name: 'Mes Completado', icon: 'üìÖ', description: 'Registraste 10+ gastos', condition: () => state.expenses.length >= 10 }
        ];

        function formatEuro(amount) {
            const num = parseFloat(amount).toFixed(2);
            const parts = num.split('.');
            return parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, '.') + ',' + parts[1] + '‚Ç¨';
        }
        
        function showMotivationToast(message, duration = 6000) {
            if (shownMotivations.has(message)) return;
            shownMotivations.add(message);
            const container = document.getElementById('motivationToasts');
            const toast = document.createElement('div');
            toast.className = 'motivation-toast';
            toast.innerHTML = '<div class="motivation-toast-content"><button class="close-btn" onclick="closeMotivationToast(this.parentElement.parentElement)">‚úï</button><p class="text-sm text-blue-800 pr-4">' + message + '</p><div class="progress-bar-toast" style="width: 100%"></div></div>';
            container.appendChild(toast);
            const progressBar = toast.querySelector('.progress-bar-toast');
            let width = 100;
            const interval = setInterval(() => { width -= (100 / (duration / 100)); progressBar.style.width = width + '%'; if (width <= 0) clearInterval(interval); }, 100);
            setTimeout(() => closeMotivationToast(toast), duration);
        }
        
        function closeMotivationToast(toast) { if (!toast || toast.classList.contains('hiding')) return; toast.classList.add('hiding'); setTimeout(() => toast.remove(), 300); }
        
        function showMotivationMessages() { const messages = getFinancialHealthMessage(); if (messages.length > 0) messages.forEach((msg, index) => setTimeout(() => showMotivationToast(msg, 6000), index * 2000)); }
        
        function loadScript(src) { return new Promise((resolve, reject) => { const script = document.createElement('script'); script.src = src; script.onload = resolve; script.onerror = reject; document.head.appendChild(script); }); }
        
        async function saveToSupabase(table, data) {
            if (!supabaseClient || !state.userId) { syncQueue.push({ table, data, action: 'upsert' }); saveDataLocal(); return false; }
            try { const { error } = await supabaseClient.from(table).upsert(data, { onConflict: table === 'user_config' ? 'user_id' : 'id' }); if (error) throw error; return true; }
            catch (error) { console.error('Error guardando:', error); syncQueue.push({ table, data, action: 'upsert' }); return false; }
        }
        
        async function deleteFromSupabase(table, id) {
            if (!supabaseClient || !state.userId) { syncQueue.push({ table, id, action: 'delete' }); saveDataLocal(); return false; }
            try { const { error } = await supabaseClient.from(table).delete().eq('id', id); if (error) throw error; return true; }
            catch (error) { console.error('Error eliminando:', error); syncQueue.push({ table, id, action: 'delete' }); return false; }
        }
        
        async function syncPendingQueue() {
            if (!supabaseClient || !state.userId || syncQueue.length === 0) return;
            const queue = [...syncQueue]; syncQueue = [];
            for (const item of queue) {
                try { if (item.action === 'upsert') await supabaseClient.from(item.table).upsert(item.data); else if (item.action === 'delete') await supabaseClient.from(item.table).delete().eq('id', item.id); }
                catch (error) { console.error('Error sincronizando:', error); syncQueue.push(item); }
            }
            saveDataLocal();
        }
        
        function toggleDarkMode() { state.darkMode = !state.darkMode; document.body.classList.toggle('dark-mode', state.darkMode); saveData(); }
        
        async function handleLogin() {
            if (!authState.email || !authState.password) { authState.authError = 'Por favor, completa todos los campos'; renderAuth(); return; }
            authState.authError = ''; authState.loading = true; renderAuth();
            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({ email: authState.email, password: authState.password });
                if (error) throw error;
                authState.isAuthenticated = true; authState.user = data.user; currentUser = data.user; state.userId = data.user.id;
                await loadDataFromSupabasePublic();
                authState.loading = false; authState.email = ''; authState.password = '';
                render(); showNotification('‚úÖ ¬°Bienvenido de nuevo!');
            } catch (error) { authState.loading = false; authState.authError = getAuthErrorMessage(error.message); renderAuth(); }
        }
        
        async function handleRegister() {
            if (!authState.email || !authState.password || !authState.confirmPassword) { authState.authError = 'Por favor, completa todos los campos'; renderAuth(); return; }
            if (authState.password !== authState.confirmPassword) { authState.authError = 'Las contrase√±as no coinciden'; renderAuth(); return; }
            if (authState.password.length < 6) { authState.authError = 'La contrase√±a debe tener al menos 6 caracteres'; renderAuth(); return; }
            authState.authError = ''; authState.loading = true; renderAuth();
            try {
                const { data, error } = await supabaseClient.auth.signUp({ email: authState.email, password: authState.password });
                if (error) throw error;
                authState.loading = false; authState.authSuccess = '‚úÖ Cuenta creada. Revisa tu email para confirmar.'; authState.authView = 'login'; authState.password = ''; authState.confirmPassword = ''; renderAuth();
            } catch (error) { authState.loading = false; authState.authError = getAuthErrorMessage(error.message); renderAuth(); }
        }
        
        async function handleForgotPassword() {
            if (!authState.email) { authState.authError = 'Por favor, introduce tu email'; renderAuth(); return; }
            authState.authError = ''; authState.loading = true; renderAuth();
            try {
                const { error } = await supabaseClient.auth.resetPasswordForEmail(authState.email, { redirectTo: window.location.origin });
                if (error) throw error;
                authState.loading = false; authState.authSuccess = '‚úÖ Te hemos enviado un email para restablecer tu contrase√±a'; authState.authView = 'login'; renderAuth();
            } catch (error) { authState.loading = false; authState.authError = getAuthErrorMessage(error.message); renderAuth(); }
        }
        
        async function handleLogout() {
            try { await supabaseClient.auth.signOut(); authState.isAuthenticated = false; authState.user = null; currentUser = null; state.userId = null;
            state.expenses = []; state.savingsWithdrawals = []; state.savingsDeposits = []; state.debtors = []; state.loans = []; state.fixedExpenses = []; state.savingsHistory = []; state.monthlyIncome = ''; state.creditCardIncome = '';
            renderAuth(); showNotification('üëã Sesi√≥n cerrada'); } catch (error) { showNotification('‚ùå Error al cerrar sesi√≥n', true); }
        }
        
        function getAuthErrorMessage(message) {
            const msgs = { 'Invalid login credentials': 'Email o contrase√±a incorrectos', 'Email not confirmed': 'Por favor, confirma tu email', 'User already registered': 'Este email ya est√° registrado', 'Password should be at least 6 characters': 'La contrase√±a debe tener al menos 6 caracteres' };
            return msgs[message] || message;
        }
        
        function setAuthView(view) { authState.authView = view; authState.authError = ''; authState.authSuccess = ''; renderAuth(); }
        
        function updateAuthField(field, value) { authState[field] = value; }
        
        function renderAuth() {
            const app = document.getElementById('app');
            if (authState.loading && !authState.isAuthenticated) { app.innerHTML = '<div class="min-h-screen flex items-center justify-center"><div class="text-center"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div><p class="text-gray-500">Cargando...</p></div></div>'; return; }
            let formContent = '';
            if (authState.authView === 'login') {
                formContent = '<h2 class="text-2xl font-bold text-gray-800 mb-2">Iniciar Sesi√≥n</h2><p class="text-gray-500 text-sm mb-6">Accede a tu organizador de gastos</p>' +
                    (authState.authSuccess ? '<div class="mb-4 p-3 bg-green-50 border border-green-200 text-green-700 rounded-lg text-sm">' + authState.authSuccess + '</div>' : '') +
                    (authState.authError ? '<div class="mb-4 p-3 bg-red-50 border border-red-200 text-red-700 rounded-lg text-sm">' + authState.authError + '</div>' : '') +
                    '<div class="space-y-4"><div><label class="block text-sm font-medium text-gray-700 mb-1">Email</label><input type="email" id="authEmail" value="' + authState.email + '" placeholder="tu@email.com" class="w-full px-4 py-3 border border-gray-200 rounded-xl" /></div>' +
                    '<div><label class="block text-sm font-medium text-gray-700 mb-1">Contrase√±a</label><input type="password" id="authPassword" value="' + authState.password + '" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full px-4 py-3 border border-gray-200 rounded-xl" /></div>' +
                    '<button onclick="handleLogin()" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-xl font-medium">Entrar</button></div>' +
                    '<div class="mt-6 text-center space-y-2"><button onclick="setAuthView(\'forgot\')" class="text-blue-500 hover:text-blue-600 text-sm">¬øOlvidaste tu contrase√±a?</button>' +
                    '<p class="text-gray-500 text-sm">¬øNo tienes cuenta? <button onclick="setAuthView(\'register\')" class="text-blue-500 hover:text-blue-600 font-medium">Reg√≠strate</button></p></div>';
            } else if (authState.authView === 'register') {
                formContent = '<h2 class="text-2xl font-bold text-gray-800 mb-2">Crear Cuenta</h2><p class="text-gray-500 text-sm mb-6">Empieza a organizar tus finanzas</p>' +
                    (authState.authError ? '<div class="mb-4 p-3 bg-red-50 border border-red-200 text-red-700 rounded-lg text-sm">' + authState.authError + '</div>' : '') +
                    '<div class="space-y-4"><div><label class="block text-sm font-medium text-gray-700 mb-1">Email</label><input type="email" id="authEmail" value="' + authState.email + '" placeholder="tu@email.com" class="w-full px-4 py-3 border border-gray-200 rounded-xl" /></div>' +
                    '<div><label class="block text-sm font-medium text-gray-700 mb-1">Contrase√±a</label><input type="password" id="authPassword" value="' + authState.password + '" placeholder="M√≠nimo 6 caracteres" class="w-full px-4 py-3 border border-gray-200 rounded-xl" /></div>' +
                    '<div><label class="block text-sm font-medium text-gray-700 mb-1">Confirmar Contrase√±a</label><input type="password" id="authConfirmPassword" value="' + authState.confirmPassword + '" placeholder="Repite la contrase√±a" class="w-full px-4 py-3 border border-gray-200 rounded-xl" /></div>' +
                    '<button onclick="handleRegister()" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white py-3 rounded-xl font-medium">Crear Cuenta</button></div>' +
                    '<div class="mt-6 text-center"><p class="text-gray-500 text-sm">¬øYa tienes cuenta? <button onclick="setAuthView(\'login\')" class="text-blue-500 hover:text-blue-600 font-medium">Inicia sesi√≥n</button></p></div>';
            } else if (authState.authView === 'forgot') {
                formContent = '<h2 class="text-2xl font-bold text-gray-800 mb-2">Recuperar Contrase√±a</h2><p class="text-gray-500 text-sm mb-6">Te enviaremos un email</p>' +
                    (authState.authError ? '<div class="mb-4 p-3 bg-red-50 border border-red-200 text-red-700 rounded-lg text-sm">' + authState.authError + '</div>' : '') +
                    '<div class="space-y-4"><div><label class="block text-sm font-medium text-gray-700 mb-1">Email</label><input type="email" id="authEmail" value="' + authState.email + '" placeholder="tu@email.com" class="w-full px-4 py-3 border border-gray-200 rounded-xl" /></div>' +
                    '<button onclick="handleForgotPassword()" class="w-full bg-violet-500 hover:bg-violet-600 text-white py-3 rounded-xl font-medium">Enviar Email</button></div>' +
                    '<div class="mt-6 text-center"><button onclick="setAuthView(\'login\')" class="text-blue-500 hover:text-blue-600 text-sm">‚Üê Volver al login</button></div>';
            }
            app.innerHTML = '<div class="min-h-screen flex items-center justify-center p-4"><div class="w-full max-w-md"><div class="text-center mb-8"><div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-emerald-500 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg"><span class="text-4xl">üí∞</span></div><h1 class="text-3xl font-bold text-gray-800">Organizador de Gastos</h1></div><div class="bg-white rounded-2xl shadow-xl p-8 border border-gray-100">' + formContent + '</div><p class="text-center text-gray-400 text-xs mt-6">Tus datos est√°n seguros</p></div></div>';
            const emailInput = document.getElementById('authEmail');
            const passwordInput = document.getElementById('authPassword');
            const confirmPasswordInput = document.getElementById('authConfirmPassword');
            if (emailInput) { emailInput.addEventListener('input', (e) => updateAuthField('email', e.target.value)); emailInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { if (authState.authView === 'login') handleLogin(); else if (authState.authView === 'forgot') handleForgotPassword(); } }); }
            if (passwordInput) { passwordInput.addEventListener('input', (e) => updateAuthField('password', e.target.value)); passwordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && authState.authView === 'login') handleLogin(); }); }
            if (confirmPasswordInput) { confirmPasswordInput.addEventListener('input', (e) => updateAuthField('confirmPassword', e.target.value)); confirmPasswordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && authState.authView === 'register') handleRegister(); }); }
        }
        
        function toggleSection(section) { state[section] = !state[section]; const element = document.getElementById(section); const button = document.getElementById(section + 'Btn'); if (element && button) { element.classList.toggle('open'); button.classList.toggle('open'); } }
        
        function setTimeFilter(filter) { state.timeFilter = filter; render(); }
        
        // ========== FUNCI√ìN CORREGIDA: getFilteredExpenses ==========
        function getFilteredExpenses() {
            const now = new Date();
            let startDate;
            switch(state.timeFilter) {
                case 'week':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 7);
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    break;
                case 'year':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    break;
                default:
                    return state.expenses;
            }
            return state.expenses.filter(exp => new Date(exp.date) >= startDate);
        }
        
        // ========== NUEVA FUNCI√ìN: getTotalFixedExpenses ==========
        function getTotalFixedExpenses() {
            return state.fixedExpenses.reduce((sum, exp) => sum + exp.amount, 0);
        }
        
        function saveDataLocal() {
            const dataToSave = { 
                expenses: state.expenses, 
                savingsWithdrawals: state.savingsWithdrawals, 
                savingsDeposits: state.savingsDeposits, 
                debtors: state.debtors, 
                loans: state.loans, 
                fixedExpenses: state.fixedExpenses, 
                savingsHistory: state.savingsHistory,
                monthlyIncome: state.monthlyIncome, 
                creditCardIncome: state.creditCardIncome, 
                projectionMonths: state.projectionMonths, 
                monthlySavingsPlan: state.monthlySavingsPlan, 
                darkMode: state.darkMode, 
                badges: state.badges, 
                lastMonthSavings: state.lastMonthSavings, 
                syncQueue: syncQueue, 
                lastSaved: new Date().toISOString() 
            };
            localStorage.setItem('expenseTrackerData', JSON.stringify(dataToSave));
        }
        
        async function saveData() {
            saveDataLocal();
            if (supabaseClient && state.userId) {
                await saveToSupabase('user_config', { 
                    user_id: state.userId, 
                    monthly_income: parseFloat(state.monthlyIncome) || 0, 
                    credit_card_income: parseFloat(state.creditCardIncome) || 0, 
                    projection_months: parseInt(state.projectionMonths) || 0, 
                    monthly_savings_plan: parseFloat(state.monthlySavingsPlan) || 0, 
                    dark_mode: state.darkMode, 
                    badges: state.badges, 
                    savings_history: state.savingsHistory 
                });
                await syncPendingQueue();
            }
            showNotification('‚úÖ Datos guardados');
        }
        
        // ========== FUNCI√ìN CLAVE: handleIncomeInput ==========
        function handleIncomeInput(field, value) {
            // Guardar el valor en el estado
            state[field] = value;
            
            // Guardar en localStorage inmediatamente
            const dataToSave = { 
                expenses: state.expenses, 
                savingsWithdrawals: state.savingsWithdrawals, 
                savingsDeposits: state.savingsDeposits, 
                debtors: state.debtors, 
                loans: state.loans, 
                fixedExpenses: state.fixedExpenses, 
                savingsHistory: state.savingsHistory,
                monthlyIncome: state.monthlyIncome, 
                creditCardIncome: state.creditCardIncome, 
                projectionMonths: state.projectionMonths, 
                monthlySavingsPlan: state.monthlySavingsPlan, 
                darkMode: state.darkMode, 
                badges: state.badges, 
                lastMonthSavings: state.lastMonthSavings
            };
            localStorage.setItem('expenseTrackerData', JSON.stringify(dataToSave));
            
            // Calcular nuevo saldo
            const totalIncome = (parseFloat(state.monthlyIncome) || 0) + (parseFloat(state.creditCardIncome) || 0);
            const totalExpenses = getFilteredExpenses().reduce((sum, exp) => sum + exp.amount, 0);
            const fixedExpenses = state.fixedExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            const monthlyLoanPayments = state.loans.reduce((sum, l) => sum + l.monthlyPayment, 0);
            const rawBalance = totalIncome - totalExpenses - fixedExpenses - monthlyLoanPayments;
            
            // Actualizar saldo en pantalla
            const saldoEl = document.querySelector('.saldo-display');
            if (saldoEl) {
                saldoEl.textContent = formatEuro(rawBalance >= 0 ? rawBalance : rawBalance);
                saldoEl.className = 'saldo-display amount-display-large ' + (rawBalance >= 0 ? 'text-emerald-600' : 'text-red-600');
            }
            
            // Guardar en Supabase con debounce
            if (saveTimeout) clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                if (supabaseClient && state.userId) {
                    saveToSupabase('user_config', { 
                        user_id: state.userId, 
                        monthly_income: parseFloat(state.monthlyIncome) || 0, 
                        credit_card_income: parseFloat(state.creditCardIncome) || 0, 
                        projection_months: parseInt(state.projectionMonths) || 0, 
                        monthly_savings_plan: parseFloat(state.monthlySavingsPlan) || 0, 
                        dark_mode: state.darkMode, 
                        badges: state.badges, 
                        savings_history: state.savingsHistory 
                    });
                }
            }, 1000);
        }
        
        function showNotification(message, isError = false) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white font-medium z-50 animate-slide-in ' + (isError ? 'bg-red-500' : 'bg-green-500');
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => { notification.style.opacity = '0'; notification.style.transition = 'opacity 0.3s'; setTimeout(() => notification.remove(), 300); }, 3000);
        }
        
        function checkBadges() { badgeDefinitions.forEach(badge => { if (badge.condition() && !state.badges.includes(badge.id)) { state.badges.push(badge.id); showNotification('üéâ ¬°Nuevo logro: ' + badge.name + '!'); } }); }
        
        function checkNoDaysNoLuxury(days) {
            if (state.expenses.length === 0) return false;
            const luxuryCategories = ['üéÆ Entretenimiento', 'üçï Restaurantes', 'üõçÔ∏è Compras', '‚úàÔ∏è Viajes'];
            const now = new Date(); const daysAgo = new Date(now.setDate(now.getDate() - days));
            const recentLuxury = state.expenses.filter(exp => luxuryCategories.includes(exp.category) && new Date(exp.date) >= daysAgo);
            return recentLuxury.length === 0 && state.expenses.some(exp => new Date(exp.date) >= daysAgo);
        }
        
        async function addExpense() {
            if (!state.description || !state.amount || parseFloat(state.amount) <= 0) { showNotification('‚ùå Completa todos los campos', true); return; }
            if (state.editingExpenseId) {
                const index = state.expenses.findIndex(exp => exp.id === state.editingExpenseId);
                if (index !== -1) { const updatedExpense = { id: state.editingExpenseId, user_id: state.userId, description: state.description, amount: parseFloat(state.amount), category: state.category, date: state.date };
                state.expenses[index] = updatedExpense; saveDataLocal(); await saveToSupabase('expenses', updatedExpense); showNotification('‚úÖ Gasto actualizado'); }
                state.editingExpenseId = null;
            } else {
                const newExpense = { id: Date.now(), user_id: state.userId, description: state.description, amount: parseFloat(state.amount), category: state.category, date: state.date };
                state.expenses.unshift(newExpense); saveDataLocal(); await saveToSupabase('expenses', newExpense); showNotification('‚úÖ Gasto a√±adido');
            }
            state.description = ''; state.amount = ''; state.date = new Date().toISOString().split('T')[0];
            checkBadges(); saveDataLocal(); render();
        }
        
        function editExpense(id) {
            const expense = state.expenses.find(exp => exp.id === id);
            if (expense) { state.editingExpenseId = id; state.description = expense.description; state.amount = expense.amount.toString(); state.category = expense.category; state.date = expense.date; render();
            setTimeout(() => { document.getElementById('description').scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 100); }
        }
        
        function cancelEdit() { state.editingExpenseId = null; state.description = ''; state.amount = ''; state.category = 'üçé Alimentaci√≥n'; state.date = new Date().toISOString().split('T')[0]; render(); }
        
        async function deleteExpense(id) { state.expenses = state.expenses.filter(exp => exp.id !== id); saveDataLocal(); await deleteFromSupabase('expenses', id); checkBadges(); render(); showNotification('üóëÔ∏è Gasto eliminado'); }
        
        function getCategoryType(catName) { const cat = categories.find(c => c.name === catName); return cat ? cat.type : 'otros'; }
        
        function getTotalByType() {
            const totals = { esencial: 0, salida: 0, ahorro: 0, bizum: 0, suscripcion: 0, otros: 0 };
            getFilteredExpenses().forEach(exp => { const type = getCategoryType(exp.category); totals[type] += exp.amount; });
            return totals;
        }
        
        // ========== FUNCIONES PARA GASTOS FIJOS ==========
        async function addFixedExpense() {
            if (!state.fixedExpenseName || !state.fixedExpenseAmount || parseFloat(state.fixedExpenseAmount) <= 0) { 
                showNotification('‚ùå Completa todos los campos', true); return; 
            }
            if (state.editingFixedExpenseId) {
                const index = state.fixedExpenses.findIndex(exp => exp.id === state.editingFixedExpenseId);
                if (index !== -1) { 
                    const updated = { id: state.editingFixedExpenseId, user_id: state.userId, name: state.fixedExpenseName, amount: parseFloat(state.fixedExpenseAmount) };
                    state.fixedExpenses[index] = updated; 
                    saveDataLocal(); 
                    await saveToSupabase('fixed_expenses', updated); 
                    showNotification('‚úÖ Gasto fijo actualizado'); 
                }
                state.editingFixedExpenseId = null;
            } else {
                const newFixed = { id: Date.now(), user_id: state.userId, name: state.fixedExpenseName, amount: parseFloat(state.fixedExpenseAmount) };
                state.fixedExpenses.unshift(newFixed); 
                saveDataLocal(); 
                await saveToSupabase('fixed_expenses', newFixed); 
                showNotification('‚úÖ Gasto fijo a√±adido');
            }
            state.fixedExpenseName = ''; state.fixedExpenseAmount = '';
            render();
        }

        function editFixedExpense(id) {
            const fixed = state.fixedExpenses.find(exp => exp.id === id);
            if (fixed) { 
                state.editingFixedExpenseId = id; 
                state.fixedExpenseName = fixed.name; 
                state.fixedExpenseAmount = fixed.amount.toString(); 
                render();
                setTimeout(() => { 
                    const section = document.getElementById('showFixedExpensesSection');
                    if (section && !section.classList.contains('open')) {
                        toggleSection('showFixedExpensesSection');
                    }
                    document.getElementById('fixedExpenseName')?.scrollIntoView({ behavior: 'smooth', block: 'center' }); 
                }, 100); 
            }
        }

        function cancelEditFixed() { 
            state.editingFixedExpenseId = null; 
            state.fixedExpenseName = ''; 
            state.fixedExpenseAmount = ''; 
            render(); 
        }

        async function deleteFixedExpense(id) { 
            state.fixedExpenses = state.fixedExpenses.filter(exp => exp.id !== id); 
            saveDataLocal(); 
            await deleteFromSupabase('fixed_expenses', id); 
            render(); 
            showNotification('üóëÔ∏è Gasto fijo eliminado'); 
        }

        function handleDeleteFixedExpense(id) { 
            if (confirm('¬øEliminar este gasto fijo?')) deleteFixedExpense(id); 
        }
        
        function getTotalByCategory() {
            const totals = {};
            const filtered = getFilteredExpenses();
            categories.forEach(cat => { totals[cat.name] = filtered.filter(exp => exp.category === cat.name).reduce((sum, exp) => sum + exp.amount, 0); });
            return totals;
        }
        
        function getTotalMonth() { return getFilteredExpenses().reduce((sum, exp) => sum + exp.amount, 0); }
        
        function getTotalIncome() { return (parseFloat(state.monthlyIncome) || 0) + (parseFloat(state.creditCardIncome) || 0); }
        
        function getTotalWithdrawals() { return state.savingsWithdrawals.reduce((sum, w) => sum + w.amount, 0); }
        
        function getTotalDeposits() { return state.savingsDeposits.reduce((sum, d) => sum + d.amount, 0); }
        
        function getNetSavings() { const typeTotals = getTotalByType(); return typeTotals.ahorro + getTotalDeposits() - getTotalWithdrawals(); }
        
        // ========== FUNCI√ìN CORREGIDA: getBalanceInfo con gastos fijos ==========
        function getBalanceInfo() {
            const totalIncome = getTotalIncome();
            const totalExpenses = getTotalMonth();
            const fixedExpenses = getTotalFixedExpenses();
            const monthlyLoanPayments = getTotalMonthlyLoanPayments();
            const rawBalance = totalIncome - totalExpenses - fixedExpenses - monthlyLoanPayments;
            const netSavings = getNetSavings();
            
            // Si el saldo es negativo, descontamos de los ahorros
            if (rawBalance < 0) {
                const deficit = Math.abs(rawBalance);
                const usedFromSavings = Math.min(deficit, Math.max(0, netSavings));
                const adjustedSavings = netSavings - usedFromSavings;
                const remainingDeficit = deficit - usedFromSavings;
                
                return {
                    rawBalance: rawBalance,
                    displayBalance: remainingDeficit > 0 ? -remainingDeficit : 0,
                    usedFromSavings: usedFromSavings,
                    adjustedSavings: adjustedSavings,
                    isUsingFromSavings: usedFromSavings > 0,
                    savingsInsufficient: remainingDeficit > 0
                };
            }
            
            return { rawBalance: rawBalance, displayBalance: rawBalance, usedFromSavings: 0, adjustedSavings: netSavings, isUsingFromSavings: false, savingsInsufficient: false };
        }
        
        async function addWithdrawal() {
            if (!state.withdrawalDescription || !state.withdrawalAmount || parseFloat(state.withdrawalAmount) <= 0) { showNotification('‚ùå Completa todos los campos', true); return; }
            const balanceInfo = getBalanceInfo();
            if (parseFloat(state.withdrawalAmount) > balanceInfo.adjustedSavings) { showNotification('‚ùå No tienes suficiente ahorro disponible', true); return; }
            const newWithdrawal = { id: Date.now(), user_id: state.userId, description: state.withdrawalDescription, amount: parseFloat(state.withdrawalAmount), date: new Date().toISOString().split('T')[0] };
            state.savingsWithdrawals.unshift(newWithdrawal); saveDataLocal(); await saveToSupabase('savings_withdrawals', newWithdrawal);
            state.withdrawalDescription = ''; state.withdrawalAmount = ''; render(); showNotification('‚úÖ Retiro registrado');
        }
        
        async function deleteWithdrawal(id) { state.savingsWithdrawals = state.savingsWithdrawals.filter(w => w.id !== id); saveDataLocal(); await deleteFromSupabase('savings_withdrawals', id); render(); showNotification('üóëÔ∏è Retiro eliminado'); }
        
        async function addDeposit() {
            if (!state.depositDescription || !state.depositAmount || parseFloat(state.depositAmount) <= 0) { showNotification('‚ùå Completa todos los campos', true); return; }
            const newDeposit = { id: Date.now(), user_id: state.userId, description: state.depositDescription, amount: parseFloat(state.depositAmount), date: new Date().toISOString().split('T')[0] };
            state.savingsDeposits.unshift(newDeposit); saveDataLocal(); await saveToSupabase('savings_deposits', newDeposit);
            state.depositDescription = ''; state.depositAmount = ''; checkBadges(); render(); showNotification('‚úÖ Ingreso registrado');
        }
        
        async function deleteDeposit(id) { state.savingsDeposits = state.savingsDeposits.filter(d => d.id !== id); saveDataLocal(); await deleteFromSupabase('savings_deposits', id); render(); showNotification('üóëÔ∏è Ingreso eliminado'); }
        
        function getTotalOwed() { return state.debtors.reduce((sum, d) => sum + d.amount, 0); }
        
        async function addDebtor() {
            if (!state.debtorName || !state.debtorAmount || parseFloat(state.debtorAmount) <= 0) { showNotification('‚ùå Completa todos los campos', true); return; }
            const newDebtor = { id: Date.now(), user_id: state.userId, name: state.debtorName, amount: parseFloat(state.debtorAmount), date: new Date().toISOString().split('T')[0] };
            state.debtors.unshift(newDebtor); saveDataLocal(); await saveToSupabase('debtors', newDebtor);
            state.debtorName = ''; state.debtorAmount = ''; render(); showNotification('‚úÖ Deudor a√±adido');
        }
        
        async function deleteDebtor(id) { state.debtors = state.debtors.filter(d => d.id !== id); saveDataLocal(); await deleteFromSupabase('debtors', id); render(); showNotification('üóëÔ∏è Deudor eliminado'); }
        
        function remindDebtorWhatsApp(name, amount) { const message = 'Hola ' + name + ', te recuerdo que me debes ' + formatEuro(amount) + '. ¬°Gracias! üòä'; window.open('https://wa.me/?text=' + encodeURIComponent(message), '_blank'); }
        
        function getTotalLoans() { return state.loans.reduce((sum, loan) => sum + loan.pendingAmount, 0); }
        
        function getTotalMonthlyLoanPayments() {
            const currentMonth = new Date().toISOString().slice(0, 7);
            return state.loans.reduce((sum, loan) => { if (loan.startDate && loan.startDate > currentMonth) return sum; return sum + loan.monthlyPayment; }, 0);
        }
        
        function isLoanActive(loan) { if (!loan.startDate) return true; const currentMonth = new Date().toISOString().slice(0, 7); return loan.startDate <= currentMonth; }
        
        // ========== FUNCI√ìN CORREGIDA: resetMonth ==========
        async function resetMonth() {
            if (!confirm('‚ö†Ô∏è ¬øEst√°s seguro de iniciar un nuevo mes?\n\n‚úÖ Se GUARDAR√ÅN:\n‚Ä¢ Gastos fijos mensuales\n‚Ä¢ Ahorros (en historial)\n‚Ä¢ Pr√©stamos\n‚Ä¢ Deudores\n\n‚ùå Se BORRAR√ÅN:\n‚Ä¢ Gastos del mes\n‚Ä¢ Ingresos del mes\n‚Ä¢ Movimientos de ahorro')) return;
            
            // Guardar el ahorro actual en el historial
            const currentMonth = new Date().toISOString().slice(0, 7);
            const currentSavings = getNetSavings();
            
            if (currentSavings !== 0) {
                const existingIndex = state.savingsHistory.findIndex(h => h.month === currentMonth);
                if (existingIndex >= 0) {
                    state.savingsHistory[existingIndex].amount = currentSavings;
                } else {
                    state.savingsHistory.push({ month: currentMonth, amount: currentSavings });
                }
            }
            
            // Borrar gastos normales
            if (supabaseClient && state.userId) {
                for (const exp of state.expenses) {
                    await deleteFromSupabase('expenses', exp.id);
                }
            }
            state.expenses = [];
            
            // Borrar ingresos
            state.monthlyIncome = ''; 
            state.creditCardIncome = '';
            
            // Resetear movimientos de ahorro del mes
            if (supabaseClient && state.userId) {
                for (const w of state.savingsWithdrawals) {
                    await deleteFromSupabase('savings_withdrawals', w.id);
                }
                for (const d of state.savingsDeposits) {
                    await deleteFromSupabase('savings_deposits', d.id);
                }
            }
            state.savingsWithdrawals = [];
            state.savingsDeposits = [];
            
            // LOS GASTOS FIJOS, PR√âSTAMOS Y DEUDORES SE MANTIENEN (NO se borran)
            
            saveDataLocal(); 
            await saveData();
            render(); 
            showNotification('üîÑ Nuevo mes iniciado - Ahorro guardado en historial');
        }
        
        async function addLoan() {
            if (!state.loanName || !state.loanAmount || !state.loanMonths || parseFloat(state.loanAmount) <= 0 || parseInt(state.loanMonths) <= 0) { showNotification('‚ùå Completa todos los campos', true); return; }
            const totalAmount = parseFloat(state.loanAmount); const months = parseInt(state.loanMonths); const paidAmount = parseFloat(state.loanPaid) || 0;
            const pendingAmount = totalAmount - paidAmount; const remainingMonths = Math.ceil(pendingAmount / (totalAmount / months)); const monthlyPayment = pendingAmount / remainingMonths;
            const startDate = state.loanStartDate || new Date().toISOString().slice(0, 7);
            const newLoan = { id: Date.now(), user_id: state.userId, name: state.loanName, totalAmount, pendingAmount, paidAmount, totalMonths: months, remainingMonths, monthlyPayment, startDate, date: new Date().toISOString().split('T')[0] };
            state.loans.unshift(newLoan); saveDataLocal();
            await saveToSupabase('loans', { id: newLoan.id, user_id: state.userId, name: newLoan.name, total_amount: newLoan.totalAmount, pending_amount: newLoan.pendingAmount, paid_amount: newLoan.paidAmount, total_months: newLoan.totalMonths, remaining_months: newLoan.remainingMonths, monthly_payment: newLoan.monthlyPayment, start_date: newLoan.startDate, date: newLoan.date });
            state.loanName = ''; state.loanAmount = ''; state.loanMonths = ''; state.loanPaid = ''; state.loanStartDate = ''; render();
            showNotification(isLoanActive(newLoan) ? '‚úÖ Pr√©stamo a√±adido' : '‚úÖ Pr√©stamo programado para ' + newLoan.startDate);
        }
        
        async function payLoan(id, amount) {
            const loan = state.loans.find(l => l.id === id); if (!loan) return;
            if (!isLoanActive(loan)) { showNotification('‚ùå Este pr√©stamo no est√° activo a√∫n', true); return; }
            const paymentAmount = parseFloat(amount) || loan.monthlyPayment;
            if (paymentAmount > loan.pendingAmount) { showNotification('‚ùå El pago excede la deuda', true); return; }
            loan.paidAmount += paymentAmount; loan.pendingAmount -= paymentAmount;
            if (loan.pendingAmount <= 0) { loan.pendingAmount = 0; loan.remainingMonths = 0; showNotification('üéâ ¬°Pr√©stamo liquidado!'); }
            else { loan.remainingMonths = Math.ceil(loan.pendingAmount / loan.monthlyPayment); showNotification('‚úÖ Pago registrado'); }
            saveDataLocal();
            await saveToSupabase('loans', { id: loan.id, user_id: state.userId, name: loan.name, total_amount: loan.totalAmount, pending_amount: loan.pendingAmount, paid_amount: loan.paidAmount, total_months: loan.totalMonths, remaining_months: loan.remainingMonths, monthly_payment: loan.monthlyPayment, start_date: loan.startDate, date: loan.date });
            render();
        }
        
        async function deleteLoan(id) { state.loans = state.loans.filter(l => l.id !== id); saveDataLocal(); await deleteFromSupabase('loans', id); render(); showNotification('üóëÔ∏è Pr√©stamo eliminado'); }
        
        function calculateProjections() {
            const months = parseFloat(state.projectionMonths) || 0; const monthlySavings = parseFloat(state.monthlySavingsPlan) || 0;
            const balanceInfo = getBalanceInfo(); const currentSavings = balanceInfo.adjustedSavings; const owed = getTotalOwed();
            const validMonthlySavings = monthlySavings <= balanceInfo.displayBalance ? monthlySavings : Math.max(0, balanceInfo.displayBalance);
            const projectionFromZero = validMonthlySavings * months; const projectionWithCurrent = currentSavings + projectionFromZero;
            return { fromZero: projectionFromZero, withCurrent: projectionWithCurrent, withoutOwed: projectionWithCurrent, withOwed: projectionWithCurrent + owed };
        }
        
        function getFinancialHealthMessage() {
            const balanceInfo = getBalanceInfo(); const netSavings = balanceInfo.adjustedSavings; const totalIncome = getTotalIncome();
            const savingsRate = totalIncome > 0 ? (netSavings / totalIncome) * 100 : 0; const typeTotals = getTotalByType();
            let messages = [];
            if (balanceInfo.isUsingFromSavings) {
                messages.push('‚ö†Ô∏è Est√°s usando ' + formatEuro(balanceInfo.usedFromSavings) + ' de tus ahorros para cubrir gastos');
                if (balanceInfo.savingsInsufficient) messages.push('üö® ¬°Cuidado! Tus ahorros no cubren todo el d√©ficit');
            } else if (savingsRate >= 20) messages.push('üåü ¬°Excelente! Est√°s ahorrando m√°s del 20% de tus ingresos');
            else if (savingsRate >= 10) messages.push('üëç Buen trabajo, est√°s ahorrando un ' + savingsRate.toFixed(1) + '%');
            else if (savingsRate > 0) messages.push('‚ö†Ô∏è Intenta aumentar tu tasa de ahorro (actual: ' + savingsRate.toFixed(1) + '%)');
            else if (totalIncome > 0) messages.push('‚ùó No est√°s ahorrando este mes');
            if (typeTotals.salida > totalIncome * 0.3) messages.push('üí° Tus gastos en salidas superan el 30%');
            return messages;
        }
        
        // ========== FUNCI√ìN: Calcular ahorro total acumulado ==========
        function getTotalAccumulatedSavings() {
            return state.savingsHistory.reduce((sum, record) => sum + record.amount, 0);
        }
        
        let chartInstance = null;
        function renderChart() {
            const ctx = document.getElementById('expenseChart'); if (!ctx) return;
            const totals = getTotalByCategory(); const labels = [], data = [], colors = [];
            const colorPalette = ['#10b981', '#3b82f6', '#8b5cf6', '#ec4899', '#ef4444', '#f59e0b', '#f97316', '#d946ef', '#06b6d4', '#14b8a6', '#6366f1', '#8b5cf6', '#64748b', '#475569'];
            categories.forEach((cat, idx) => { if (totals[cat.name] > 0) { labels.push(cat.displayName); data.push(totals[cat.name]); colors.push(colorPalette[idx % colorPalette.length]); } });
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, { type: 'doughnut', data: { labels, datasets: [{ data, backgroundColor: colors, borderWidth: 2, borderColor: '#fff' }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { padding: 10, font: { size: 10 } } },
                tooltip: { callbacks: { label: function(context) { const value = context.parsed; const total = context.dataset.data.reduce((a, b) => a + b, 0); return context.label + ': ' + formatEuro(value) + ' (' + ((value / total) * 100).toFixed(1) + '%)'; } } } } }
            });
        }
        
        function renderBadges() {
            const earnedBadges = badgeDefinitions.filter(b => state.badges.includes(b.id)); if (earnedBadges.length === 0) return '';
            return '<div class="flex gap-2 flex-wrap">' + earnedBadges.map(badge => '<div class="badge-item"><span class="badge-icon">' + badge.icon + '</span><span>' + badge.name + '</span><div class="badge-tooltip">' + badge.description + '</div></div>').join('') + '</div>';
        }
        
        function handleDeleteExpense(id) { if (confirm('¬øEliminar este gasto?')) deleteExpense(id); }
        function handleDeleteWithdrawal(id) { if (confirm('¬øEliminar este retiro?')) deleteWithdrawal(id); }
        function handleDeleteDeposit(id) { if (confirm('¬øEliminar este ingreso?')) deleteDeposit(id); }
        function handleDeleteDebtor(id) { if (confirm('¬øEliminar este deudor?')) deleteDebtor(id); }
        function handleDeleteLoan(id) { if (confirm('¬øEliminar este pr√©stamo?')) deleteLoan(id); }
        
        function showExpensesByType(type, title) {
            const filtered = getFilteredExpenses().filter(exp => getCategoryType(exp.category) === type);
            const total = filtered.reduce((sum, exp) => sum + exp.amount, 0);
            let content = filtered.length === 0 ? '<p class="text-gray-400 text-center py-8">No hay gastos</p>' :
                '<div class="mb-4 p-3 bg-gray-50 rounded-lg flex justify-between items-center"><span class="text-sm text-gray-600">' + filtered.length + ' gasto' + (filtered.length !== 1 ? 's' : '') + '</span><span class="font-bold text-gray-800">' + formatEuro(total) + '</span></div><div class="space-y-2">' +
                filtered.map(exp => '<div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg"><div class="flex-1 min-w-0"><p class="font-medium text-sm text-gray-800 truncate">' + exp.description + '</p><p class="text-xs text-gray-400">' + exp.category + ' ‚Ä¢ ' + exp.date + '</p></div><span class="font-semibold text-gray-800 ml-3">' + formatEuro(exp.amount) + '</span></div>').join('') + '</div>';
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('detailModal').classList.remove('hidden');
        }
        
        function showSavingsDetail() {
            const savingsExpenses = getFilteredExpenses().filter(exp => getCategoryType(exp.category) === 'ahorro');
            const totalFromExpenses = savingsExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            const balanceInfo = getBalanceInfo();
            const totalAccumulated = getTotalAccumulatedSavings();
            
            let content = '<div class="space-y-3 mb-4">' +
                '<div class="p-3 bg-emerald-50 rounded-lg flex justify-between items-center"><span class="text-sm text-emerald-700">Por categor√≠as</span><span class="font-bold text-emerald-800">' + formatEuro(totalFromExpenses) + '</span></div>' +
                '<div class="p-3 bg-blue-50 rounded-lg flex justify-between items-center"><span class="text-sm text-blue-700">Ingresos extras</span><span class="font-bold text-blue-800">+' + formatEuro(getTotalDeposits()) + '</span></div>' +
                '<div class="p-3 bg-red-50 rounded-lg flex justify-between items-center"><span class="text-sm text-red-700">Retiros</span><span class="font-bold text-red-800">-' + formatEuro(getTotalWithdrawals()) + '</span></div>' +
                (balanceInfo.isUsingFromSavings ? '<div class="p-3 bg-amber-50 rounded-lg flex justify-between items-center border border-amber-200"><span class="text-sm text-amber-700">‚ö†Ô∏è Usado para cubrir d√©ficit</span><span class="font-bold text-amber-800">-' + formatEuro(balanceInfo.usedFromSavings) + '</span></div>' : '') +
                '<div class="p-3 bg-gray-100 rounded-lg flex justify-between items-center border-t-2 ' + (balanceInfo.adjustedSavings >= 0 ? 'border-emerald-500' : 'border-red-500') + '"><span class="text-sm font-semibold text-gray-700">Ahorro Este Mes</span><span class="font-bold ' + (balanceInfo.adjustedSavings >= 0 ? 'text-emerald-700' : 'text-red-700') + '">' + formatEuro(balanceInfo.adjustedSavings) + '</span></div></div>';
            
            // Mostrar historial de ahorros
            if (state.savingsHistory.length > 0) {
                content += '<div class="border-t border-gray-200 pt-3 mt-3">' +
                    '<div class="flex justify-between items-center mb-3"><p class="text-xs font-semibold text-gray-500 uppercase">üìä Historial Mensual</p>' +
                    '<div class="px-2 py-1 bg-emerald-100 rounded-full"><span class="text-xs font-bold text-emerald-700">Total: ' + formatEuro(totalAccumulated) + '</span></div></div>' +
                    '<div class="space-y-2 max-h-48 overflow-y-auto custom-scroll">';
                
                state.savingsHistory.slice().reverse().forEach(record => {
                    const monthName = new Date(record.month + '-01').toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
                    const isPositive = record.amount >= 0;
                    content += '<div class="flex justify-between items-center p-2 ' + (isPositive ? 'savings-history-item' : 'bg-red-50 border border-red-200') + ' rounded-lg">' +
                        '<span class="text-xs text-gray-600 capitalize">' + monthName + '</span>' +
                        '<span class="font-semibold ' + (isPositive ? 'text-emerald-700' : 'text-red-600') + ' text-sm">' + formatEuro(record.amount) + '</span></div>';
                });
                content += '</div></div>';
            } else {
                content += '<div class="border-t border-gray-200 pt-3 mt-3 text-center"><p class="text-gray-400 text-xs py-2">üìä El historial aparecer√° cuando uses "Reset (nuevo mes)"</p></div>';
            }
            
            document.getElementById('modalTitle').textContent = 'Ahorro Neto';
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('detailModal').classList.remove('hidden');
        }
        
        function showLoansDetail() {
            const activeLoans = state.loans.filter(l => l.pendingAmount > 0);
            let content = activeLoans.length === 0 ? '<p class="text-gray-400 text-center py-8">No hay pr√©stamos</p>' :
                '<div class="space-y-3 mb-4"><div class="p-3 bg-orange-50 rounded-lg flex justify-between items-center"><span class="text-sm text-orange-700">Deuda total</span><span class="font-bold text-orange-800">' + formatEuro(getTotalLoans()) + '</span></div>' +
                '<div class="p-3 bg-gray-100 rounded-lg flex justify-between items-center"><span class="text-sm text-gray-700">Cuota mensual</span><span class="font-bold text-gray-800">' + formatEuro(getTotalMonthlyLoanPayments()) + '</span></div></div><div class="space-y-2">' +
                activeLoans.map(l => '<div class="p-3 bg-orange-50 rounded-lg"><p class="font-medium text-sm text-gray-800">' + l.name + '</p><div class="flex justify-between text-xs mt-1"><span class="text-gray-500">Pendiente: ' + formatEuro(l.pendingAmount) + '</span><span class="text-gray-500">Cuota: ' + formatEuro(l.monthlyPayment) + '</span></div></div>').join('') + '</div>';
            document.getElementById('modalTitle').textContent = 'Pr√©stamos';
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('detailModal').classList.remove('hidden');
        }
        
        function showFixedExpensesDetail() {
            const total = getTotalFixedExpenses();
            let content = state.fixedExpenses.length === 0 ? '<p class="text-gray-400 text-center py-8">No hay gastos fijos</p>' :
                '<div class="mb-4 p-3 bg-blue-50 rounded-lg flex justify-between items-center"><span class="text-sm text-blue-700">Total mensual</span><span class="font-bold text-blue-800">' + formatEuro(total) + '</span></div><div class="space-y-2">' +
                state.fixedExpenses.map(exp => '<div class="flex justify-between items-center p-3 fixed-expense-badge rounded-lg"><div class="flex-1 min-w-0"><p class="font-medium text-sm text-gray-800">üìå ' + exp.name + '</p></div><span class="font-semibold text-blue-700 ml-3">' + formatEuro(exp.amount) + '</span></div>').join('') + '</div>';
            document.getElementById('modalTitle').textContent = 'Gastos Fijos Mensuales';
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('detailModal').classList.remove('hidden');
        }
        
        function closeDetailModal(event) { if (!event || event.target.id === 'detailModal') document.getElementById('detailModal').classList.add('hidden'); }
     
        function exportData() {
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.getWidth(); const margin = 15; let y = 20;
            doc.setFillColor(59, 130, 246); doc.rect(0, 0, pageWidth, 40, 'F');
            doc.setTextColor(255, 255, 255); doc.setFontSize(24); doc.setFont('helvetica', 'bold');
            doc.text('Organizador de Gastos', pageWidth / 2, 18, { align: 'center' });
            doc.setFontSize(12); doc.setFont('helvetica', 'normal');
            doc.text('Reporte generado el ' + new Date().toLocaleDateString('es-ES'), pageWidth / 2, 30, { align: 'center' });
            y = 55; doc.setTextColor(0, 0, 0); doc.setFontSize(16); doc.setFont('helvetica', 'bold');
            doc.text('Resumen Financiero', margin, y); y += 10;
            const balanceInfo = getBalanceInfo();
            doc.autoTable({ startY: y, head: [['Concepto', 'Importe']], body: [
                ['Total Ingresos', formatEuro(getTotalIncome())], 
                ['Total Gastos Variables', formatEuro(getTotalMonth())],
                ['Gastos Fijos Mensuales', formatEuro(getTotalFixedExpenses())],
                ['Cuotas Pr√©stamos', formatEuro(getTotalMonthlyLoanPayments())], 
                ['Saldo Disponible', formatEuro(balanceInfo.displayBalance)],
                ['Ahorro Este Mes', formatEuro(balanceInfo.adjustedSavings)], 
                ['Ahorro Acumulado', formatEuro(getTotalAccumulatedSavings())],
                ['Me Deben', formatEuro(getTotalOwed())], 
                ['Deuda Pr√©stamos', formatEuro(getTotalLoans())]
            ], theme: 'striped', headStyles: { fillColor: [59, 130, 246] }, margin: { left: margin, right: margin } });
            doc.save('reporte_gastos_' + new Date().toISOString().split('T')[0] + '.pdf');
            showNotification('üìÑ PDF descargado');
        }
        
        function importData(event) {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    state.expenses = data.expenses || []; 
                    state.savingsWithdrawals = data.savingsWithdrawals || [];
                    state.savingsDeposits = data.savingsDeposits || [];
                    state.debtors = data.debtors || [];
                    state.loans = data.loans || [];
                    state.fixedExpenses = data.fixedExpenses || [];
                    state.savingsHistory = data.savingsHistory || [];
                    state.monthlyIncome = data.monthlyIncome || '';
                    state.creditCardIncome = data.creditCardIncome || ''; 
                    state.projectionMonths = data.projectionMonths || '';
                    state.monthlySavingsPlan = data.monthlySavingsPlan || '';
                    saveData(); render(); showNotification('‚úÖ Datos importados');
                } catch (error) { showNotification('‚ùå Error al importar', true); }
            };
            reader.readAsText(file);
        }
        
        function render() {
            const typeTotals = getTotalByType(); 
            const totals = getTotalByCategory(); 
            const monthTotal = getTotalMonth();
            const totalLoans = getTotalLoans(); 
            const monthlyLoanPayments = getTotalMonthlyLoanPayments();
            const fixedExpensesTotal = getTotalFixedExpenses();
            const balanceInfo = getBalanceInfo(); 
            const projections = calculateProjections();
            const earnedBadges = badgeDefinitions.filter(b => state.badges.includes(b.id));
            const hasExpenses = Object.values(totals).some(v => v > 0);
            const totalAccumulatedSavings = getTotalAccumulatedSavings();
            
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="header-card rounded-2xl shadow-sm p-4 mb-4 animate-slide-in relative">
                    <div class="absolute top-4 right-4 grid grid-cols-2 gap-1.5 sm:flex sm:flex-row sm:gap-2">
                        <button onclick="toggleDarkMode()" class="action-btn bg-gray-100 hover:bg-gray-200">${state.darkMode ? '‚òÄÔ∏è' : 'üåô'}</button>
                        <button onclick="saveData()" class="action-btn bg-emerald-500 hover:bg-emerald-600 text-white">üíæ</button>
                        <button onclick="exportData()" class="action-btn bg-blue-500 hover:bg-blue-600 text-white">üì•</button>
                        <label class="action-btn bg-violet-500 hover:bg-violet-600 text-white cursor-pointer">üì§<input type="file" accept=".json" onchange="importData(event)" class="hidden" /></label>
                        <button onclick="handleLogout()" class="action-btn bg-red-500 hover:bg-red-600 text-white" title="Cerrar sesi√≥n">üö™</button>
                    </div>
                    <div class="pr-24 sm:pr-56">
                        <div class="sm:hidden"><h1 class="text-lg font-bold text-gray-800">üí∞ Organizador de Gastos</h1>
                            <div class="connection-status ${isOnline ? 'online' : 'offline'} w-fit mt-1"><span class="connection-dot ${isOnline ? 'online' : 'offline'}"></span>${isOnline ? 'Sincronizado' : 'Local'}</div></div>
                        <div class="hidden sm:flex sm:items-center sm:gap-3"><h1 class="text-2xl font-bold text-gray-800">üí∞ Organizador de Gastos</h1>
                            <div class="connection-status ${isOnline ? 'online' : 'offline'}"><span class="connection-dot ${isOnline ? 'online' : 'offline'}"></span>${isOnline ? 'Sincronizado' : 'Local'}</div>
                            ${authState.user ? '<div class="flex items-center gap-2 px-3 py-1.5 bg-gray-50 rounded-lg"><span class="text-xs text-gray-500">üë§</span><span class="text-xs text-gray-600 font-medium truncate max-w-[150px]">' + authState.user.email + '</span></div>' : ''}</div>
                    </div>
                    <div class="flex flex-wrap items-center gap-4 mb-4 mt-3">
                        <div class="flex gap-2">
                            <button onclick="setTimeFilter('week')" class="time-filter px-3 py-1.5 rounded-lg text-xs ${state.timeFilter === 'week' ? 'time-filter-active' : 'text-gray-600'}">Semana</button>
                            <button onclick="setTimeFilter('month')" class="time-filter px-3 py-1.5 rounded-lg text-xs ${state.timeFilter === 'month' ? 'time-filter-active' : 'text-gray-600'}">Mes</button>
                            <button onclick="setTimeFilter('year')" class="time-filter px-3 py-1.5 rounded-lg text-xs ${state.timeFilter === 'year' ? 'time-filter-active' : 'text-gray-600'}">A√±o</button>
                        </div>
                        ${earnedBadges.length > 0 ? '<div class="flex items-center gap-2"><span class="text-xs text-gray-400">üèÜ ' + earnedBadges.length + '/' + badgeDefinitions.length + '</span>' + renderBadges() + '</div>' : ''}
                    </div>
                    <div class="grid grid-cols-3 gap-3">
                        <div class="income-card"><label class="text-xs text-gray-400 block mb-1">üíµ Ingresos</label><input type="number" id="monthlyIncome" value="${state.monthlyIncome}" placeholder="0,00‚Ç¨" step="0.01" oninput="handleIncomeInput('monthlyIncome', this.value)" /></div>
                        <div class="income-card"><label class="text-xs text-gray-400 block mb-1">üéÅ Donaciones</label><input type="number" id="creditCardIncome" value="${state.creditCardIncome}" placeholder="0,00‚Ç¨" step="0.01" oninput="handleIncomeInput('creditCardIncome', this.value)" /></div>
                        <div class="income-card" style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border-color: #a7f3d0;"><label class="text-xs text-emerald-600 block mb-1">ü§ù Me deben</label><div class="text-lg font-bold text-emerald-700">${formatEuro(getTotalOwed())}</div></div>
                    </div>
                </div>
                <div class="totals-grid mb-4">
                    <div class="total-card rounded-xl p-4 border-l-4 ${balanceInfo.isUsingFromSavings ? 'border-amber-500 using-savings-indicator' : 'border-blue-500'} animate-slide-in col-span-2 md:col-span-1">
                        <p class="text-gray-500 text-xs mb-1">Saldo Disponible</p>
                        <p class="saldo-display amount-display-large ${balanceInfo.displayBalance >= 0 ? 'text-emerald-600' : 'text-red-600'}">${formatEuro(balanceInfo.displayBalance)}</p>
                        ${fixedExpensesTotal > 0 ? '<p class="text-xs text-gray-400 mt-1">-' + formatEuro(fixedExpensesTotal) + ' fijos</p>' : ''}
                        ${monthlyLoanPayments > 0 ? '<p class="text-xs text-gray-400">-' + formatEuro(monthlyLoanPayments) + ' pr√©stamos</p>' : ''}
                        ${balanceInfo.isUsingFromSavings ? '<p class="text-xs text-amber-600 mt-1 font-medium">‚ö†Ô∏è Usando ' + formatEuro(balanceInfo.usedFromSavings) + ' de ahorros</p>' : ''}
                    </div>
                    <div class="total-card rounded-xl p-3 border-l-4 border-green-400 animate-slide-in cursor-pointer hover:bg-green-50" onclick="showExpensesByType('esencial', 'Esenciales')"><p class="text-gray-400 text-xs">Esenciales</p><p class="amount-display text-gray-800">${formatEuro(typeTotals.esencial)}</p></div>
                    <div class="total-card rounded-xl p-3 border-l-4 border-pink-400 animate-slide-in cursor-pointer hover:bg-pink-50">
                        <div onclick="showExpensesByType('salida', 'Salidas')"><p class="text-gray-400 text-xs">Salidas</p><p class="amount-display text-gray-800">${formatEuro(typeTotals.salida)}</p></div>
                        <div class="border-t border-pink-200 mt-2 pt-2" onclick="showExpensesByType('suscripcion', 'Suscripciones')"><p class="text-gray-400 text-xs">Suscripciones</p><p class="amount-display text-violet-600">${formatEuro(typeTotals.suscripcion)}</p></div>
                    </div>
                    <div id="ahorroMesCard" class="total-card rounded-xl p-3 border-l-4 ${balanceInfo.isUsingFromSavings ? 'border-amber-400' : 'border-emerald-400'} animate-slide-in cursor-pointer hover:bg-emerald-50" onclick="showSavingsDetail()">
                        <p class="text-gray-400 text-xs">Ahorro Mes</p><p id="ahorroMesDisplay" class="amount-display ${balanceInfo.adjustedSavings >= 0 ? 'text-emerald-600' : 'text-red-600'}">${formatEuro(balanceInfo.adjustedSavings)}</p>
                        ${totalAccumulatedSavings > 0 ? '<p class="text-xs text-emerald-500 mt-0.5">üìä ' + formatEuro(totalAccumulatedSavings) + ' total</p>' : ''}
                    </div>
                    <div class="total-card rounded-xl p-3 border-l-4 border-indigo-400 animate-slide-in cursor-pointer hover:bg-indigo-50" onclick="showExpensesByType('bizum', 'Bizums')"><p class="text-gray-400 text-xs">Bizums</p><p class="amount-display text-gray-800">${formatEuro(typeTotals.bizum)}</p></div>
                    <div class="total-card rounded-xl p-3 border-l-4 border-sky-400 animate-slide-in cursor-pointer hover:bg-sky-50" onclick="showFixedExpensesDetail()"><p class="text-gray-400 text-xs">G. Fijos</p><p class="amount-display text-sky-600">${formatEuro(fixedExpensesTotal)}</p></div>
                    <div class="total-card rounded-xl p-3 border-l-4 border-orange-400 animate-slide-in cursor-pointer hover:bg-orange-50" onclick="showLoansDetail()"><p class="text-gray-400 text-xs">Pr√©stamos</p><p class="amount-display text-orange-600">${formatEuro(totalLoans)}</p></div>
                </div>
                <div id="detailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="closeDetailModal(event)">
                    <div class="bg-white rounded-2xl max-w-lg w-full max-h-[80vh] overflow-hidden shadow-2xl" onclick="event.stopPropagation()">
                        <div class="p-4 border-b border-gray-100 flex justify-between items-center"><h3 id="modalTitle" class="text-lg font-semibold text-gray-800"></h3><button onclick="closeDetailModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button></div>
                        <div id="modalContent" class="p-4 overflow-y-auto max-h-[60vh] custom-scroll"></div>
                    </div>
                </div>
                <div class="grid md:grid-cols-3 gap-4 mb-4">
                    <div class="bg-white rounded-xl p-4 sm:p-5 card animate-slide-in border ${state.editingExpenseId ? 'border-amber-300 ring-2 ring-amber-100' : 'border-gray-100'}">
                        <h2 class="text-base font-semibold text-gray-800 mb-4">${state.editingExpenseId ? '‚úèÔ∏è Editar Gasto' : '‚ûï Nuevo Gasto'}</h2>
                        <div class="space-y-3">
                            <input type="text" id="description" value="${state.description}" placeholder="Descripci√≥n" class="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm" />
                            <div class="grid grid-cols-2 gap-2 sm:gap-3"><input type="number" id="amount" value="${state.amount}" placeholder="0.00" step="0.01" class="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm" /><input type="date" id="date" value="${state.date}" class="w-full px-2 py-2.5 border border-gray-200 rounded-lg text-sm" /></div>
                            <select id="category" class="w-full px-3 py-2.5 border border-gray-200 rounded-lg text-sm">${categories.map(cat => '<option value="' + cat.name + '"' + (state.category === cat.name ? ' selected' : '') + '>' + cat.name + '</option>').join('')}</select>
                            <div class="flex gap-2"><button onclick="addExpense()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2.5 rounded-lg text-sm">${state.editingExpenseId ? '‚úì Actualizar' : '+ Agregar'}</button>${state.editingExpenseId ? '<button onclick="cancelEdit()" class="px-4 bg-gray-200 hover:bg-gray-300 text-gray-700 py-2.5 rounded-lg text-sm">‚úï</button>' : ''}</div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl p-5 card animate-slide-in border border-gray-100">
                        <h2 class="text-base font-semibold text-gray-800 mb-3">üìä Distribuci√≥n</h2>
                        ${hasExpenses ? '<div style="height: 220px; position: relative;"><canvas id="expenseChart"></canvas></div>' : '<div class="flex items-center justify-center h-[220px] text-gray-400 text-sm">Sin gastos registrados</div>'}
                    </div>
                    <div class="bg-white rounded-xl p-5 card animate-slide-in border border-gray-100">
                        <div class="flex justify-between items-center mb-3"><h2 class="text-base font-semibold text-gray-800">üìù Historial</h2>${getFilteredExpenses().length > 0 ? '<span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full font-medium">' + getFilteredExpenses().length + ' gastos</span>' : ''}</div>
                        <div class="space-y-2 max-h-[400px] overflow-y-auto custom-scroll">
                            ${getFilteredExpenses().length === 0 ? '<p class="text-gray-400 text-center py-8 text-sm">Sin gastos registrados</p>' : getFilteredExpenses().map(exp => '<div class="expense-item flex items-center justify-between p-2.5 rounded-lg"><div class="flex-1 min-w-0"><div class="flex items-center gap-2 mb-0.5"><span class="px-2 py-0.5 rounded-full text-xs font-medium ' + categoryColors[exp.category] + ' truncate">' + exp.category.split(' ')[0] + '</span><span class="font-medium text-gray-800 text-sm truncate">' + exp.description + '</span></div><span class="text-xs text-gray-400">' + exp.date + '</span></div><div class="flex items-center gap-1 flex-shrink-0"><span class="font-semibold text-sm text-gray-800">' + formatEuro(exp.amount) + '</span><button onclick="editExpense(' + exp.id + ')" class="text-gray-400 hover:text-blue-500 p-1.5 hover:bg-blue-50 rounded-lg">‚úèÔ∏è</button><button onclick="handleDeleteExpense(' + exp.id + ')" class="text-gray-400 hover:text-red-500 p-1.5 hover:bg-red-50 rounded-lg">üóëÔ∏è</button></div></div>').join('')}
                        </div>
                        ${getFilteredExpenses().length > 0 ? '<div class="mt-3 pt-3 border-t border-gray-100"><div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg"><span class="text-sm font-medium text-gray-600">Total Gastos</span><span class="amount-display-large text-blue-600">' + formatEuro(monthTotal) + '</span></div></div>' : ''}
                    </div>
                </div>
                <div class="grid md:grid-cols-5 gap-4 mb-4">
                    <div class="bg-white rounded-xl p-5 card animate-slide-in-right border border-gray-100">
                        <button onclick="toggleSection('showFixedExpensesSection')" class="w-full flex justify-between items-center mb-3">
                            <h2 class="text-base font-semibold text-gray-800">üìå Gastos Fijos</h2>
                            <span id="showFixedExpensesSectionBtn" class="toggle-btn text-lg ${state.showFixedExpensesSection ? 'open' : ''}">‚ñº</span>
                        </button>
                        <div id="showFixedExpensesSection" class="collapsible-content ${state.showFixedExpensesSection ? 'open' : ''} custom-scroll">
                            <div class="mb-3 p-3 bg-blue-50 rounded-lg text-center">
                                <p class="text-xs text-gray-500 mb-1">Total mensual</p>
                                <p class="text-xl font-bold text-blue-600">${formatEuro(fixedExpensesTotal)}</p>
                                <p class="text-xs text-blue-500 mt-1">Se descuenta del saldo</p>
                            </div>
                            <div class="space-y-2 mb-3 ${state.editingFixedExpenseId ? 'border-2 border-amber-200 p-2 rounded-lg' : ''}">
                                ${state.editingFixedExpenseId ? '<p class="text-xs text-amber-600 font-semibold mb-2">‚úèÔ∏è Editando gasto fijo</p>' : ''}
                                <input type="text" id="fixedExpenseName" value="${state.fixedExpenseName}" placeholder="Nombre (ej: Alquiler)" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" />
                                <input type="number" id="fixedExpenseAmount" value="${state.fixedExpenseAmount}" placeholder="Cantidad" step="0.01" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" />
                                <div class="flex gap-2">
                                    <button onclick="addFixedExpense()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg text-sm">${state.editingFixedExpenseId ? '‚úì Actualizar' : '+ A√±adir'}</button>
                                    ${state.editingFixedExpenseId ? '<button onclick="cancelEditFixed()" class="px-4 bg-gray-200 hover:bg-gray-300 text-gray-700 py-2 rounded-lg text-sm">‚úï</button>' : ''}
                                </div>
                            </div>
                            ${state.fixedExpenses.length > 0 ? '<div class="space-y-2">' + state.fixedExpenses.map(exp => '<div class="flex justify-between items-center p-2 fixed-expense-badge rounded-lg"><div class="flex-1 min-w-0"><p class="font-medium text-xs text-gray-800 truncate">üìå ' + exp.name + '</p></div><div class="flex items-center gap-1"><span class="font-semibold text-blue-700 text-sm">' + formatEuro(exp.amount) + '</span><button onclick="editFixedExpense(' + exp.id + ')" class="text-gray-400 hover:text-blue-500 p-1">‚úèÔ∏è</button><button onclick="handleDeleteFixedExpense(' + exp.id + ')" class="text-gray-400 hover:text-red-500 p-1">üóëÔ∏è</button></div></div>').join('') + '</div>' : '<p class="text-gray-400 text-xs text-center py-3">Sin gastos fijos</p>'}
                        </div>
                    </div>
                    <div class="bg-white rounded-xl p-5 card animate-slide-in-right border border-gray-100">
                        <button onclick="toggleSection('showSavingsSection')" class="w-full flex justify-between items-center mb-3"><h2 class="text-base font-semibold text-gray-800">üí∏ Ahorros</h2><span id="showSavingsSectionBtn" class="toggle-btn text-lg ${state.showSavingsSection ? 'open' : ''}">‚ñº</span></button>
                        <div id="showSavingsSection" class="collapsible-content ${state.showSavingsSection ? 'open' : ''} custom-scroll">
                            <div class="mb-3 p-3 ${balanceInfo.isUsingFromSavings ? 'bg-amber-50' : 'bg-emerald-50'} rounded-lg">
                                <div class="flex justify-between text-xs text-gray-600 mb-1"><span>Por categor√≠a</span><span class="font-semibold text-emerald-700">${formatEuro(typeTotals.ahorro)}</span></div>
                                <div class="flex justify-between text-xs text-gray-600 mb-1"><span>Ingresos extras</span><span class="font-semibold text-emerald-700">+${formatEuro(getTotalDeposits())}</span></div>
                                <div class="flex justify-between text-xs text-gray-600 mb-1"><span>Retiros</span><span class="font-semibold text-red-600">-${formatEuro(getTotalWithdrawals())}</span></div>
                                ${balanceInfo.isUsingFromSavings ? '<div class="flex justify-between text-xs text-gray-600 mb-1 border-t border-amber-200 pt-1 mt-1"><span class="text-amber-700">‚ö†Ô∏è Usado para d√©ficit</span><span class="font-semibold text-amber-700">-' + formatEuro(balanceInfo.usedFromSavings) + '</span></div>' : ''}
                                <div class="flex justify-between border-t ${balanceInfo.isUsingFromSavings ? 'border-amber-200' : 'border-emerald-200'} pt-2 mt-1"><span class="text-sm font-medium text-gray-700">Este Mes</span><span class="text-sm font-bold ${balanceInfo.adjustedSavings >= 0 ? 'text-emerald-700' : 'text-red-700'}">${formatEuro(balanceInfo.adjustedSavings)}</span></div>
                                ${totalAccumulatedSavings > 0 ? '<div class="flex justify-between pt-1"><span class="text-xs text-gray-500">üìä Acumulado</span><span class="text-xs font-bold text-emerald-600">' + formatEuro(totalAccumulatedSavings) + '</span></div>' : ''}
                            </div>
                            <div class="mb-3 p-3 bg-blue-50 rounded-lg"><p class="text-xs font-semibold text-blue-700 mb-2">‚ûï A√±adir ingreso</p><div class="space-y-2"><input type="text" id="depositDescription" value="${state.depositDescription}" placeholder="Concepto" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" /><input type="number" id="depositAmount" value="${state.depositAmount}" placeholder="Cantidad" step="0.01" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" /><button onclick="addDeposit()" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white py-2 rounded-lg text-sm">+ Ingresar</button></div></div>
                            <div class="mb-3 p-3 bg-red-50 rounded-lg"><p class="text-xs font-semibold text-red-700 mb-2">‚ûñ Registrar retiro</p><div class="space-y-2"><input type="text" id="withdrawalDescription" value="${state.withdrawalDescription}" placeholder="Motivo" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" /><input type="number" id="withdrawalAmount" value="${state.withdrawalAmount}" placeholder="Cantidad" step="0.01" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" /><button onclick="addWithdrawal()" class="w-full bg-red-500 hover:bg-red-600 text-white py-2 rounded-lg text-sm">‚àí Retirar</button></div></div>
                            ${(state.savingsDeposits.length > 0 || state.savingsWithdrawals.length > 0) ? '<div class="space-y-2"><p class="text-xs font-semibold text-gray-500 uppercase">Movimientos del mes</p>' + state.savingsDeposits.map(d => '<div class="flex justify-between items-center p-2 bg-emerald-50 rounded-lg"><div class="flex-1 min-w-0"><p class="font-medium text-xs text-gray-800 truncate">' + d.description + '</p><p class="text-xs text-gray-400">' + d.date + '</p></div><div class="flex items-center gap-1"><span class="font-semibold text-emerald-600 text-sm">+' + formatEuro(d.amount) + '</span><button onclick="handleDeleteDeposit(' + d.id + ')" class="text-gray-400 hover:text-red-500 p-1">üóëÔ∏è</button></div></div>').join('') + state.savingsWithdrawals.map(w => '<div class="flex justify-between items-center p-2 bg-red-50 rounded-lg"><div class="flex-1 min-w-0"><p class="font-medium text-xs text-gray-800 truncate">' + w.description + '</p><p class="text-xs text-gray-400">' + w.date + '</p></div><div class="flex items-center gap-1"><span class="font-semibold text-red-600 text-sm">-' + formatEuro(w.amount) + '</span><button onclick="handleDeleteWithdrawal(' + w.id + ')" class="text-gray-400 hover:text-red-500 p-1">üóëÔ∏è</button></div></div>').join('') + '</div>' : '<p class="text-gray-400 text-xs text-center py-2">Sin movimientos</p>'}
                            ${state.savingsHistory.length > 0 ? '<div class="mt-3 pt-3 border-t border-gray-200"><p class="text-xs font-semibold text-gray-500 uppercase mb-2">üìä Historial</p><div class="space-y-1 max-h-32 overflow-y-auto custom-scroll">' + state.savingsHistory.slice().reverse().slice(0, 6).map(record => { const monthName = new Date(record.month + '-01').toLocaleDateString('es-ES', { month: 'short', year: '2-digit' }); return '<div class="flex justify-between items-center p-1.5 bg-gray-50 rounded text-xs"><span class="text-gray-500 capitalize">' + monthName + '</span><span class="font-semibold ' + (record.amount >= 0 ? 'text-emerald-600' : 'text-red-600') + '">' + formatEuro(record.amount) + '</span></div>'; }).join('') + '</div></div>' : ''}
                        </div>
                    </div>
                    <div class="bg-white rounded-xl p-5 card animate-slide-in-right border border-gray-100">
                        <button onclick="toggleSection('showLoansSection')" class="w-full flex justify-between items-center mb-3"><h2 class="text-base font-semibold text-gray-800">üè¶ Pr√©stamos</h2><span id="showLoansSectionBtn" class="toggle-btn text-lg ${state.showLoansSection ? 'open' : ''}">‚ñº</span></button>
                        <div id="showLoansSection" class="collapsible-content ${state.showLoansSection ? 'open' : ''} custom-scroll">
                            <div class="mb-3 p-3 bg-orange-50 rounded-lg"><div class="flex justify-between text-xs text-gray-600 mb-1"><span>Deuda total</span><span class="font-semibold text-orange-700">${formatEuro(totalLoans)}</span></div><div class="flex justify-between border-t border-orange-200 pt-2"><span class="text-sm font-medium text-gray-700">Cuota mensual</span><span class="text-sm font-bold text-orange-700">${formatEuro(monthlyLoanPayments)}</span></div></div>
                            <div class="space-y-2 mb-3"><input type="text" id="loanName" value="${state.loanName}" placeholder="Nombre pr√©stamo" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" /><div class="grid grid-cols-2 gap-2"><input type="number" id="loanAmount" value="${state.loanAmount}" placeholder="Capital" step="0.01" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" /><input type="number" id="loanMonths" value="${state.loanMonths}" placeholder="Meses" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" /></div><input type="number" id="loanPaid" value="${state.loanPaid}" placeholder="Ya pagado (opcional)" step="0.01" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" /><div><label class="text-xs text-gray-500 mb-1 block">1¬™ cuota</label><input type="month" id="loanStartDate" value="${state.loanStartDate}" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" /></div><button onclick="addLoan()" class="w-full bg-orange-500 hover:bg-orange-600 text-white py-2 rounded-lg text-sm">+ A√±adir</button></div>
                            ${state.loans.length > 0 ? '<div class="space-y-3">' + state.loans.map(l => { const active = isLoanActive(l); return '<div class="p-3 ' + (active ? 'bg-orange-50 border-orange-200' : 'bg-gray-50 border-gray-200') + ' rounded-lg border"><div class="flex justify-between items-start mb-2"><div class="flex-1 min-w-0"><p class="font-semibold text-sm text-gray-800 truncate">' + l.name + '</p><p class="text-xs text-gray-500">' + l.remainingMonths + ' meses</p></div><button onclick="handleDeleteLoan(' + l.id + ')" class="text-gray-400 hover:text-red-500 p-1">üóëÔ∏è</button></div><div class="flex justify-between text-xs mb-2"><span class="text-gray-500">Pendiente</span><span class="font-bold text-orange-700">' + formatEuro(l.pendingAmount) + '</span></div><div class="w-full bg-gray-200 rounded-full h-1.5 mb-2"><div class="' + (active ? 'bg-orange-500' : 'bg-gray-400') + ' h-1.5 rounded-full" style="width: ' + (l.paidAmount / l.totalAmount) * 100 + '%"></div></div><button onclick="payLoan(' + l.id + ')" class="w-full ' + (active ? 'bg-emerald-500 hover:bg-emerald-600' : 'bg-gray-400') + ' text-white py-1.5 rounded text-xs"' + (!active ? ' disabled' : '') + '>‚úì Pagar ' + formatEuro(l.monthlyPayment) + '</button></div>'; }).join('') + '</div>' : '<p class="text-gray-400 text-xs text-center py-3">Sin pr√©stamos</p>'}
                        </div>
                    </div>
                    <div class="bg-white rounded-xl p-5 card animate-slide-in-right border border-gray-100">
                        <button onclick="toggleSection('showDebtorsSection')" class="w-full flex justify-between items-center mb-3"><h2 class="text-base font-semibold text-gray-800">üíµ Me Deben</h2><span id="showDebtorsSectionBtn" class="toggle-btn text-lg ${state.showDebtorsSection ? 'open' : ''}">‚ñº</span></button>
                        <div id="showDebtorsSection" class="collapsible-content ${state.showDebtorsSection ? 'open' : ''} custom-scroll">
                            <div class="mb-3 p-3 bg-blue-50 rounded-lg text-center"><p class="text-xs text-gray-500 mb-1">Total pendiente</p><p class="text-xl font-bold text-blue-600">${formatEuro(getTotalOwed())}</p></div>
                            <div class="space-y-2 mb-3"><input type="text" id="debtorName" value="${state.debtorName}" placeholder="Nombre" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" /><input type="number" id="debtorAmount" value="${state.debtorAmount}" placeholder="Cantidad" step="0.01" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" /><button onclick="addDebtor()" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg text-sm">+ A√±adir</button></div>
                            ${state.debtors.length > 0 ? '<div class="space-y-2">' + state.debtors.map(d => '<div class="flex justify-between items-center p-2 bg-blue-50 rounded-lg"><div class="flex-1 min-w-0"><p class="font-medium text-xs text-gray-800 truncate">' + d.name + '</p><p class="text-xs text-gray-400">' + d.date + '</p></div><div class="flex items-center gap-1"><span class="font-semibold text-blue-600 text-sm">' + formatEuro(d.amount) + '</span><button onclick="remindDebtorWhatsApp(\'' + d.name + '\', ' + d.amount + ')" class="text-gray-400 hover:text-green-500 p-1" title="WhatsApp">üì±</button><button onclick="handleDeleteDebtor(' + d.id + ')" class="text-gray-400 hover:text-red-500 p-1">üóëÔ∏è</button></div></div>').join('') + '</div>' : '<p class="text-gray-400 text-xs text-center py-3">Sin deudas</p>'}
                        </div>
                    </div>
                    <div class="bg-white rounded-xl p-5 card animate-slide-in-right border border-gray-100">
                        <button onclick="toggleSection('showProjectionsSection')" class="w-full flex justify-between items-center mb-3"><h2 class="text-base font-semibold text-gray-800">üìà Proyecciones</h2><span id="showProjectionsSectionBtn" class="toggle-btn text-lg ${state.showProjectionsSection ? 'open' : ''}">‚ñº</span></button>
                        <div id="showProjectionsSection" class="collapsible-content ${state.showProjectionsSection ? 'open' : ''} custom-scroll">
                            <div class="space-y-2 mb-3"><input type="number" id="projectionMonths" value="${state.projectionMonths}" placeholder="Meses" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" /><input type="number" id="monthlySavingsPlan" value="${state.monthlySavingsPlan}" placeholder="Ahorro mensual" step="0.01" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" /></div>
                            ${state.projectionMonths && state.monthlySavingsPlan ? '<div class="grid grid-cols-2 gap-2"><div class="bg-blue-50 p-3 rounded-lg"><p class="text-xs text-blue-600 mb-1">Desde cero</p><p class="text-sm font-bold text-blue-800">' + formatEuro(projections.fromZero) + '</p></div><div class="bg-emerald-50 p-3 rounded-lg"><p class="text-xs text-emerald-600 mb-1">Con actual</p><p class="text-sm font-bold text-emerald-800">' + formatEuro(projections.withCurrent) + '</p></div><div class="bg-violet-50 p-3 rounded-lg"><p class="text-xs text-violet-600 mb-1">Sin prestado</p><p class="text-sm font-bold text-violet-800">' + formatEuro(projections.withoutOwed) + '</p></div><div class="bg-amber-50 p-3 rounded-lg"><p class="text-xs text-amber-600 mb-1">Si pagan</p><p class="text-sm font-bold text-amber-800">' + formatEuro(projections.withOwed) + '</p></div></div>' : '<p class="text-gray-400 text-xs text-center py-3">Completa los campos</p>'}
                        </div>
                    </div>
                </div>
                <div class="pt-4 border-t border-gray-200"><button onclick="resetMonth()" class="w-full bg-gray-100 hover:bg-red-50 text-gray-500 hover:text-red-600 py-3 rounded-xl text-sm font-medium border border-gray-200 hover:border-red-200">üîÑ Reset (nuevo mes) - Guarda ahorros en historial</button></div>
            `;
            
            let saveTimeout = null;
            function debouncedSave() { if (saveTimeout) clearTimeout(saveTimeout); saveTimeout = setTimeout(() => { saveDataLocal(); if (supabaseClient && state.userId) saveToSupabase('user_config', { user_id: state.userId, monthly_income: parseFloat(state.monthlyIncome) || 0, credit_card_income: parseFloat(state.creditCardIncome) || 0, projection_months: parseInt(state.projectionMonths) || 0, monthly_savings_plan: parseFloat(state.monthlySavingsPlan) || 0, dark_mode: state.darkMode, badges: state.badges, savings_history: state.savingsHistory }); }, 1000); }
            
            // monthlyIncome y creditCardIncome usan oninput="handleIncomeInput" directamente
            ['projectionMonths', 'monthlySavingsPlan'].forEach(id => { const el = document.getElementById(id); if (el) el.addEventListener('input', (e) => { state[id] = e.target.value; render(); debouncedSave(); }); });
            ['description', 'amount', 'withdrawalDescription', 'withdrawalAmount', 'depositDescription', 'depositAmount', 'debtorName', 'debtorAmount', 'loanName', 'loanAmount', 'loanMonths', 'loanPaid', 'loanStartDate', 'fixedExpenseName', 'fixedExpenseAmount'].forEach(id => {
                const el = document.getElementById(id); if (el) el.addEventListener('input', (e) => state[id] = e.target.value); 
            });
            const categoryEl = document.getElementById('category'); if (categoryEl) categoryEl.addEventListener('change', (e) => state.category = e.target.value);
            const dateEl = document.getElementById('date'); if (dateEl) dateEl.addEventListener('change', (e) => state.date = e.target.value);
            setTimeout(() => renderChart(), 100);
        }
        
        async function autoInit() {
            const savedData = localStorage.getItem('expenseTrackerData');
            if (savedData) {
                const data = JSON.parse(savedData);
                Object.assign(state, { 
                    expenses: data.expenses || [], 
                    savingsWithdrawals: data.savingsWithdrawals || [], 
                    savingsDeposits: data.savingsDeposits || [], 
                    debtors: data.debtors || [], 
                    loans: data.loans || [], 
                    fixedExpenses: data.fixedExpenses || [], 
                    savingsHistory: data.savingsHistory || [],
                    monthlyIncome: data.monthlyIncome || '', 
                    creditCardIncome: data.creditCardIncome || '', 
                    projectionMonths: data.projectionMonths || '', 
                    monthlySavingsPlan: data.monthlySavingsPlan || '', 
                    darkMode: data.darkMode || false, 
                    badges: data.badges || [], 
                    lastMonthSavings: data.lastMonthSavings || 0 
                });
                syncQueue = data.syncQueue || [];
            }
            document.body.classList.toggle('dark-mode', state.darkMode);
            if (SUPABASE_CONFIG.url && SUPABASE_CONFIG.anonKey) {
                try {
                    if (!window.supabase) await loadScript('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2');
                    supabaseClient = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
                    SUPABASE_CONFIG.initialized = true; isOnline = true;
                    const { data: { session } } = await supabaseClient.auth.getSession();
                    if (session && session.user) {
                        authState.isAuthenticated = true; authState.user = session.user; authState.loading = false; currentUser = session.user; state.userId = session.user.id;
                        await loadDataFromSupabasePublic(); checkBadges(); render();
                        setTimeout(() => showMotivationMessages(), 1500); showNotification('‚úÖ Conectado');
                    } else { authState.isAuthenticated = false; authState.loading = false; renderAuth(); }
                    supabaseClient.auth.onAuthStateChange(async (event, session) => {
                        if (event === 'SIGNED_IN' && session) { authState.isAuthenticated = true; authState.user = session.user; currentUser = session.user; state.userId = session.user.id; await loadDataFromSupabasePublic(); checkBadges(); render(); }
                        else if (event === 'SIGNED_OUT') { authState.isAuthenticated = false; authState.user = null; currentUser = null; state.userId = null; renderAuth(); }
                    });
                } catch (error) { console.error('Error auto-init:', error); isOnline = false; authState.loading = false; renderAuth(); }
            } else { authState.loading = false; renderAuth(); }
        }

        async function loadDataFromSupabasePublic() {
            if (!supabaseClient || !state.userId) return;
            try {
                const localExpenses = [...state.expenses]; 
                const localWithdrawals = [...state.savingsWithdrawals];
                const localDeposits = [...state.savingsDeposits]; 
                const localDebtors = [...state.debtors]; 
                const localLoans = [...state.loans];
                const localFixed = [...state.fixedExpenses];

                const { data: expenses } = await supabaseClient.from('expenses').select('*').eq('user_id', state.userId).order('date', { ascending: false });
                if (expenses && expenses.length > 0) {
                    const supabaseIds = new Set(expenses.map(e => e.id));
                    const localOnly = localExpenses.filter(e => !supabaseIds.has(e.id) && e.user_id === state.userId);
                    state.expenses = [...expenses, ...localOnly];
                    for (const exp of localOnly) await saveToSupabase('expenses', exp);
                } else if (localExpenses.length > 0) {
                    state.expenses = localExpenses.filter(e => e.user_id === state.userId);
                    for (const exp of state.expenses) await saveToSupabase('expenses', exp);
                }

                const { data: withdrawals } = await supabaseClient.from('savings_withdrawals').select('*').eq('user_id', state.userId).order('date', { ascending: false });
                if (withdrawals && withdrawals.length > 0) {
                    const supabaseIds = new Set(withdrawals.map(w => w.id));
                    const localOnly = localWithdrawals.filter(w => !supabaseIds.has(w.id) && w.user_id === state.userId);
                    state.savingsWithdrawals = [...withdrawals, ...localOnly];
                    for (const item of localOnly) await saveToSupabase('savings_withdrawals', item);
                } else if (localWithdrawals.length > 0) {
                    state.savingsWithdrawals = localWithdrawals.filter(w => w.user_id === state.userId);
                    for (const item of state.savingsWithdrawals) await saveToSupabase('savings_withdrawals', item);
                }

                const { data: deposits } = await supabaseClient.from('savings_deposits').select('*').eq('user_id', state.userId).order('date', { ascending: false });
                if (deposits && deposits.length > 0) {
                    const supabaseIds = new Set(deposits.map(d => d.id));
                    const localOnly = localDeposits.filter(d => !supabaseIds.has(d.id) && d.user_id === state.userId);
                    state.savingsDeposits = [...deposits, ...localOnly];
                    for (const item of localOnly) await saveToSupabase('savings_deposits', item);
                } else if (localDeposits.length > 0) {
                    state.savingsDeposits = localDeposits.filter(d => d.user_id === state.userId);
                    for (const item of state.savingsDeposits) await saveToSupabase('savings_deposits', item);
                }

                const { data: debtors } = await supabaseClient.from('debtors').select('*').eq('user_id', state.userId).order('date', { ascending: false });
                if (debtors && debtors.length > 0) {
                    const supabaseIds = new Set(debtors.map(d => d.id));
                    const localOnly = localDebtors.filter(d => !supabaseIds.has(d.id) && d.user_id === state.userId);
                    state.debtors = [...debtors, ...localOnly];
                    for (const item of localOnly) await saveToSupabase('debtors', item);
                } else if (localDebtors.length > 0) {
                    state.debtors = localDebtors.filter(d => d.user_id === state.userId);
                    for (const item of state.debtors) await saveToSupabase('debtors', item);
                }

                const { data: loans } = await supabaseClient.from('loans').select('*').eq('user_id', state.userId).order('date', { ascending: false });
                if (loans && loans.length > 0) {
                    const mappedLoans = loans.map(l => ({ id: l.id, user_id: l.user_id, name: l.name, totalAmount: l.total_amount, pendingAmount: l.pending_amount, paidAmount: l.paid_amount, totalMonths: l.total_months, remainingMonths: l.remaining_months, monthlyPayment: l.monthly_payment, startDate: l.start_date || l.date?.slice(0, 7), date: l.date }));
                    const supabaseIds = new Set(mappedLoans.map(l => l.id));
                    const localOnly = localLoans.filter(l => !supabaseIds.has(l.id) && l.user_id === state.userId);
                    state.loans = [...mappedLoans, ...localOnly];
                    for (const loan of localOnly) await saveToSupabase('loans', { id: loan.id, user_id: loan.user_id, name: loan.name, total_amount: loan.totalAmount, pending_amount: loan.pendingAmount, paid_amount: loan.paidAmount, total_months: loan.totalMonths, remaining_months: loan.remainingMonths, monthly_payment: loan.monthlyPayment, start_date: loan.startDate, date: loan.date });
                } else if (localLoans.length > 0) {
                    state.loans = localLoans.filter(l => l.user_id === state.userId);
                    for (const loan of state.loans) await saveToSupabase('loans', { id: loan.id, user_id: loan.user_id, name: loan.name, total_amount: loan.totalAmount, pending_amount: loan.pendingAmount, paid_amount: loan.paidAmount, total_months: loan.totalMonths, remaining_months: loan.remainingMonths, monthly_payment: loan.monthlyPayment, start_date: loan.startDate, date: loan.date });
                }

                // Cargar gastos fijos
                const { data: fixedExpenses } = await supabaseClient.from('fixed_expenses').select('*').eq('user_id', state.userId);
                if (fixedExpenses && fixedExpenses.length > 0) {
                    const supabaseIds = new Set(fixedExpenses.map(f => f.id));
                    const localOnly = localFixed.filter(f => !supabaseIds.has(f.id) && f.user_id === state.userId);
                    state.fixedExpenses = [...fixedExpenses, ...localOnly];
                    for (const item of localOnly) await saveToSupabase('fixed_expenses', item);
                } else if (localFixed.length > 0) {
                    state.fixedExpenses = localFixed.filter(f => f.user_id === state.userId);
                    for (const item of state.fixedExpenses) await saveToSupabase('fixed_expenses', item);
                }

                const { data: config } = await supabaseClient.from('user_config').select('*').eq('user_id', state.userId).single();
                if (config) {
                    state.monthlyIncome = config.monthly_income || state.monthlyIncome || '';
                    state.creditCardIncome = config.credit_card_income || state.creditCardIncome || '';
                    state.projectionMonths = config.projection_months || state.projectionMonths || '';
                    state.monthlySavingsPlan = config.monthly_savings_plan || state.monthlySavingsPlan || '';
                    state.darkMode = config.dark_mode || false;
                    state.badges = config.badges || state.badges || [];
                    state.savingsHistory = config.savings_history || state.savingsHistory || [];
                }

                state.lastSync = new Date().toISOString(); saveDataLocal(); checkBadges();
            } catch (error) { console.error('Error cargando datos:', error); }
        }

        autoInit();
    </script>
</body>
</html>
