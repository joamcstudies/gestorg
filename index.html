<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organizador de Gastos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(12px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.03); }
        }
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Animaci√≥n para toasts de motivaci√≥n */
        @keyframes slideInFromRight {
            from { opacity: 0; transform: translateX(100%) scale(0.8); }
            to { opacity: 1; transform: translateX(0) scale(1); }
        }
        @keyframes slideOutToRight {
            from { opacity: 1; transform: translateX(0) scale(1); }
            to { opacity: 0; transform: translateX(100%) scale(0.8); }
        }
        @keyframes floatBubble {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        /* Animaciones para badges */
        @keyframes badgePopIn {
            0% { opacity: 0; transform: scale(0) rotate(-10deg); }
            50% { transform: scale(1.2) rotate(5deg); }
            100% { opacity: 1; transform: scale(1) rotate(0); }
        }
        @keyframes badgeShine {
            0% { left: -100%; }
            100% { left: 200%; }
        }
        @keyframes iconBounce {
            0%, 100% { transform: translateY(0); }
            25% { transform: translateY(-3px) rotate(-5deg); }
            75% { transform: translateY(-3px) rotate(5deg); }
        }
        
        .animate-slide-in { animation: slideIn 0.25s ease-out; }
        .animate-slide-in-right { animation: slideInRight 0.25s ease-out; }
        .animate-pulse-once { animation: pulse 0.4s ease-in-out; }
        .animate-fade-in { animation: fadeIn 0.25s ease-out; }
        .progress-bar { transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.3s; }
        
        /* Toast de motivaci√≥n */
        .motivation-toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 100;
            max-width: 320px;
            animation: slideInFromRight 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), floatBubble 3s ease-in-out infinite 0.4s;
        }
        .motivation-toast.hiding {
            animation: slideOutToRight 0.3s ease-in forwards;
        }
        .motivation-toast-content {
            background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%);
            border: 1px solid #bae6fd;
            border-radius: 16px;
            padding: 16px 20px;
            box-shadow: 0 10px 40px rgba(59, 130, 246, 0.15), 0 4px 12px rgba(0,0,0,0.05);
            position: relative;
            overflow: hidden;
        }
        .motivation-toast-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6, #06b6d4, #3b82f6);
            background-size: 200% 100%;
            animation: shimmer 2s linear infinite;
        }
        .motivation-toast .close-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #f1f5f9;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #64748b;
            transition: all 0.2s;
        }
        .motivation-toast .close-btn:hover {
            background: #e2e8f0;
            color: #334155;
        }
        .motivation-toast .progress-bar-toast {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6, #06b6d4);
            border-radius: 0 0 16px 16px;
            transition: width 0.1s linear;
        }
        
        /* Badges din√°micos */
        .badge-item {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            font-size: 0.7rem;
            font-weight: 500;
            color: #475569;
            cursor: default;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            overflow: hidden;
            opacity: 0;
            animation: badgePopIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }
        .badge-item:nth-child(1) { animation-delay: 0.1s; }
        .badge-item:nth-child(2) { animation-delay: 0.15s; }
        .badge-item:nth-child(3) { animation-delay: 0.2s; }
        .badge-item:nth-child(4) { animation-delay: 0.25s; }
        .badge-item:nth-child(5) { animation-delay: 0.3s; }
        .badge-item:nth-child(6) { animation-delay: 0.35s; }
        .badge-item:nth-child(7) { animation-delay: 0.4s; }
        
        .badge-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 50%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
        }
        .badge-item:hover::before {
            animation: badgeShine 0.6s ease-out;
        }
        .badge-item:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: #fbbf24;
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        }
        .badge-item .badge-icon {
            font-size: 0.85rem;
            transition: transform 0.3s;
        }
        .badge-item:hover .badge-icon {
            animation: iconBounce 0.5s ease-in-out;
        }
        
        /* Tooltip para badges */
        .badge-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-8px);
            padding: 6px 10px;
            background: #1e293b;
            color: white;
            font-size: 0.6rem;
            border-radius: 6px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
            z-index: 10;
        }
        .badge-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 4px solid transparent;
            border-top-color: #1e293b;
        }
        .badge-item:hover .badge-tooltip {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(-4px);
        }
        
        /* Fondo suave */
        .gradient-bg {
            background: linear-gradient(135deg, #f0f4f8 0%, #e2e8f0 50%, #f0f4f8 100%);
            min-height: 100vh;
        }
        
        /* Modo oscuro */
        body.dark-mode {
            background: #0f172a !important;
            color: #e2e8f0;
        }
        body.dark-mode .bg-white { background-color: #1e293b !important; color: #e2e8f0; }
        body.dark-mode .text-gray-800 { color: #f1f5f9 !important; }
        body.dark-mode .text-gray-600 { color: #94a3b8 !important; }
        body.dark-mode .text-gray-500 { color: #64748b !important; }
        body.dark-mode .border-gray-300 { border-color: #334155 !important; }
        body.dark-mode input, body.dark-mode select { 
            background-color: #0f172a !important; 
            color: #e2e8f0 !important; 
            border-color: #334155 !important; 
        }
        body.dark-mode .bg-gray-50 { background-color: #1e293b !important; }
        body.dark-mode .gradient-bg { background: #0f172a; }
        body.dark-mode .total-card { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); }
        body.dark-mode .card { background: #1e293b; border: 1px solid #334155; }
        body.dark-mode #detailModal > div { background: #1e293b; }
        body.dark-mode #detailModal h3 { color: #e2e8f0; }
        body.dark-mode #detailModal .bg-gray-50 { background: #0f172a; }
        body.dark-mode #detailModal .bg-gray-100 { background: #334155; }
        body.dark-mode #detailModal .text-gray-800 { color: #e2e8f0; }
        body.dark-mode #detailModal .text-gray-600 { color: #94a3b8; }
        body.dark-mode #detailModal .text-gray-500 { color: #64748b; }
        body.dark-mode #detailModal .text-gray-400 { color: #64748b; }
        body.dark-mode #detailModal .border-gray-100 { border-color: #334155; }
        body.dark-mode .badge-item {
            background: #1e293b;
            border-color: #334155;
            color: #e2e8f0;
        }
        body.dark-mode .badge-item:hover {
            background: linear-gradient(135deg, #422006 0%, #78350f 100%);
            border-color: #fbbf24;
        }
        body.dark-mode .motivation-toast-content {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-color: #334155;
        }
        body.dark-mode .motivation-toast-content p {
            color: #e2e8f0;
        }
        body.dark-mode .header-card {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        }
        body.dark-mode .income-card {
            background: #0f172a;
            border-color: #334155;
        }
        
        /* Estilos de autenticaci√≥n en modo oscuro */
        body.dark-mode .auth-card {
            background: #1e293b;
            border-color: #334155;
        }
        body.dark-mode .auth-card input {
            background: #0f172a !important;
            border-color: #334155 !important;
            color: #e2e8f0 !important;
        }
        body.dark-mode .auth-card h2 {
            color: #f1f5f9;
        }
        body.dark-mode .auth-card p {
            color: #94a3b8;
        }
        
        /* Filtros de tiempo */
        .time-filter {
            background: white;
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
        }
        .time-filter:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }
        .time-filter-active { 
            background: #3b82f6 !important;
            border-color: #3b82f6 !important;
            color: white !important;
            font-weight: 600;
        }
        
        /* Tarjetas */
        .card { 
            transition: all 0.2s ease;
            background: white;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }
        .card:hover { 
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
        }
        
        /* Header card especial */
        .header-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid #e2e8f0;
        }
        
        /* Income cards */
        .income-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 12px 16px;
            transition: all 0.2s;
        }
        .income-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
        }
        .income-card:focus-within {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .income-card input {
            border: none !important;
            padding: 0 !important;
            background: transparent !important;
            font-size: 1.125rem;
            font-weight: 600;
            color: #1e293b;
        }
        .income-card input:focus {
            outline: none !important;
            box-shadow: none !important;
        }
        .income-card input::placeholder {
            color: #94a3b8;
            font-weight: 400;
        }
        
        /* Tarjetas de totales */
        .total-card {
            background: white;
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
            min-width: 0;
            overflow: hidden;
        }
        .total-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        /* Contenedor de cantidad con texto responsive */
        .amount-display {
            font-size: clamp(0.875rem, 2.5vw, 1.25rem);
            line-height: 1.3;
            word-break: break-word;
            overflow-wrap: break-word;
            font-weight: 700;
            letter-spacing: -0.02em;
        }
        
        .amount-display-large {
            font-size: clamp(1.125rem, 3vw, 1.5rem);
            line-height: 1.3;
            word-break: break-word;
            overflow-wrap: break-word;
            font-weight: 700;
            letter-spacing: -0.02em;
        }
        
        /* Grid de totales responsive */
        .totals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 0.75rem;
        }
        
        @media (min-width: 768px) {
            .totals-grid {
                grid-template-columns: repeat(7, 1fr);
            }
        }
        
        @media (max-width: 1200px) {
            .totals-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .totals-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .motivation-toast {
                right: 12px;
                left: 12px;
                max-width: none;
            }
        }
        
        /* Secciones colapsables */
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.25s ease-out;
        }
        .collapsible-content.open {
            max-height: 600px;
            overflow-y: auto;
        }
        
        /* Bot√≥n toggle */
        .toggle-btn {
            transition: transform 0.2s ease;
            color: #64748b;
        }
        .toggle-btn.open {
            transform: rotate(180deg);
        }
        
        /* Scroll personalizado */
        .custom-scroll::-webkit-scrollbar {
            width: 5px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* Items de gastos */
        .expense-item {
            transition: all 0.15s ease;
            background: #fafafa;
            border: 1px solid transparent;
        }
        .expense-item:hover {
            background: #f0f9ff;
            border-color: #bae6fd;
        }
        
        /* Indicador de conexi√≥n */
        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.25rem 0.625rem;
            border-radius: 9999px;
            font-size: 0.65rem;
            font-weight: 500;
            letter-spacing: 0.01em;
        }
        .connection-status.online {
            background: #dcfce7;
            color: #166534;
        }
        .connection-status.offline {
            background: #fee2e2;
            color: #991b1b;
        }
        .connection-dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
        }
        .connection-dot.online { background: #22c55e; }
        .connection-dot.offline { background: #ef4444; }
        
        /* Action buttons */
        .action-btn {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 1.1rem;
            flex-shrink: 0;
        }
        .action-btn:hover {
            transform: translateY(-2px);
        }
        
        /* Botones en m√≥vil - 2 en 2 */
        .action-btn-mobile {
            width: calc(50% - 4px);
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 1.1rem;
            flex-shrink: 0;
        }
        .action-btn-mobile:hover {
            transform: translateY(-2px);
        }
        
        @media (min-width: 640px) {
            .action-btn-mobile {
                width: 40px;
            }
        }
        
        /* Inputs mejorados */
        input, select {
            font-size: 0.875rem;
            box-sizing: border-box;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Fix para input date en m√≥vil */
        input[type="date"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            min-width: 0 !important;
            max-width: 100% !important;
            width: 100% !important;
            box-sizing: border-box !important;
        }
        
        /* Asegurar que el grid no desborde */
        .grid {
            max-width: 100%;
        }
        
        .grid > * {
            min-width: 0;
            max-width: 100%;
        }
        
        /* Botones */
        button {
            font-weight: 500;
        }
    </style>
</head>
<body class="min-h-screen gradient-bg">
    
    <!-- Contenedor para toasts de motivaci√≥n -->
    <div id="motivationToasts"></div>
    
    <div id="app" class="p-4 max-w-7xl mx-auto"></div>

    <script>
        // ========== CONFIGURACI√ìN SUPABASE ==========
        const SUPABASE_CONFIG = {
            url: 'https://zdbpzndvuqtfemkfjman.supabase.co',
            anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpkYnB6bmR2dXF0ZmVta2ZqbWFuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MDI2MTEsImV4cCI6MjA4MjA3ODYxMX0.2Wb2mhplCe0DQtLOM3jNDVTUFyz1qAiFOag1loP2e8g',
            initialized: false
        };

        let supabaseClient = null;
        let currentUser = null;
        let isOnline = false;
        let syncQueue = [];
        let shownMotivations = new Set();
        
        // ========== ESTADO DE AUTENTICACI√ìN ==========
        let authState = {
            isAuthenticated: false,
            user: null,
            loading: true,
            authView: 'login', // 'login', 'register', 'forgot'
            email: '',
            password: '',
            confirmPassword: '',
            authError: '',
            authSuccess: ''
        };

        // ========== ESTADO DE LA APLICACI√ìN ==========
        let state = {
            expenses: [],
            savingsWithdrawals: [],
            savingsDeposits: [],
            debtors: [],
            loans: [],
            monthlyIncome: '',
            creditCardIncome: '',
            owedMoney: '',
            projectionMonths: '',
            monthlySavingsPlan: '',
            description: '',
            amount: '',
            category: 'üçé Alimentaci√≥n',
            date: new Date().toISOString().split('T')[0],
            withdrawalDescription: '',
            withdrawalAmount: '',
            depositDescription: '',
            depositAmount: '',
            debtorName: '',
            debtorAmount: '',
            loanName: '',
            loanAmount: '',
            loanMonths: '',
            loanPaid: '',
            loanStartDate: '',
            editingExpenseId: null,
            darkMode: false,
            timeFilter: 'month',
            badges: [],
            lastMonthSavings: 0,
            showSavingsSection: false,
            showDebtorsSection: false,
            showProjectionsSection: false,
            showLoansSection: false,
            userId: null,
            lastSync: null
        };

        const categories = [
            { name: 'üçé Alimentaci√≥n', displayName: 'Alimentaci√≥n', type: 'esencial', icon: 'üçé' },
            { name: 'üöó Transporte', displayName: 'Transporte', type: 'esencial', icon: 'üöó' },
            { name: 'üè† Vivienda', displayName: 'Vivienda', type: 'esencial', icon: 'üè†' },
            { name: 'üíä Salud', displayName: 'Salud', type: 'esencial', icon: 'üíä' },
            { name: 'üìö Educaci√≥n', displayName: 'Educaci√≥n', type: 'esencial', icon: 'üìö' },
            { name: 'üéÆ Entretenimiento', displayName: 'Entretenimiento', type: 'salida', icon: 'üéÆ' },
            { name: 'üçï Restaurantes', displayName: 'Restaurantes', type: 'salida', icon: 'üçï' },
            { name: 'üõçÔ∏è Compras', displayName: 'Compras', type: 'salida', icon: 'üõçÔ∏è' },
            { name: '‚úàÔ∏è Viajes', displayName: 'Viajes', type: 'salida', icon: '‚úàÔ∏è' },
            { name: 'üí∞ Ahorro', displayName: 'Ahorro', type: 'ahorro', icon: 'üí∞' },
            { name: 'üìà Inversiones', displayName: 'Inversiones', type: 'ahorro', icon: 'üìà' },
            { name: 'üí∏ Bizum', displayName: 'Bizum', type: 'bizum', icon: 'üí∏' },
            { name: 'üîÑ Suscripciones', displayName: 'Suscripciones', type: 'suscripcion', icon: 'üîÑ' },
            { name: 'üì¶ Otros Gastos', displayName: 'Otros Gastos', type: 'otros', icon: 'üì¶' },
            { name: 'üîß Varios', displayName: 'Varios', type: 'otros', icon: 'üîß' }
        ];

        const categoryColors = {
            'üçé Alimentaci√≥n': 'bg-green-100 text-green-800',
            'üöó Transporte': 'bg-blue-100 text-blue-800',
            'üè† Vivienda': 'bg-purple-100 text-purple-800',
            'üéÆ Entretenimiento': 'bg-pink-100 text-pink-800',
            'üíä Salud': 'bg-red-100 text-red-800',
            'üìö Educaci√≥n': 'bg-yellow-100 text-yellow-800',
            'üçï Restaurantes': 'bg-orange-100 text-orange-800',
            'üõçÔ∏è Compras': 'bg-fuchsia-100 text-fuchsia-800',
            '‚úàÔ∏è Viajes': 'bg-cyan-100 text-cyan-800',
            'üí∞ Ahorro': 'bg-emerald-100 text-emerald-800',
            'üìà Inversiones': 'bg-teal-100 text-teal-800',
            'üí∏ Bizum': 'bg-indigo-100 text-indigo-800',
            'üîÑ Suscripciones': 'bg-violet-100 text-violet-800',
            'üì¶ Otros Gastos': 'bg-gray-100 text-gray-800',
            'üîß Varios': 'bg-slate-100 text-slate-800'
        };

        const badgeDefinitions = [
            { id: 'first_saving', name: 'Primer Ahorro', icon: 'üå±', description: 'Registraste tu primer ahorro', condition: () => getTotalByType().ahorro > 0 },
            { id: 'save_100', name: 'Ahorrador Novato', icon: 'üíµ', description: 'Ahorraste m√°s de 100‚Ç¨', condition: () => getTotalByType().ahorro >= 100 },
            { id: 'save_500', name: 'Ahorrador Experto', icon: 'üíé', description: 'Ahorraste m√°s de 500‚Ç¨', condition: () => getTotalByType().ahorro >= 500 },
            { id: 'save_1000', name: 'Maestro del Ahorro', icon: 'üëë', description: 'Ahorraste m√°s de 1000‚Ç¨', condition: () => getTotalByType().ahorro >= 1000 },
            { id: 'positive_balance', name: 'Balance Positivo', icon: '‚úÖ', description: 'Tu saldo es positivo', condition: () => (getTotalIncome() - getTotalMonth() - getTotalMonthlyLoanPayments()) > 0 },
            { id: 'no_luxury_3days', name: '3 D√≠as Sin Caprichos', icon: 'üéØ', description: '3 d√≠as sin gastos innecesarios', condition: () => checkNoDaysNoLuxury(3) },
            { id: 'month_complete', name: 'Mes Completado', icon: 'üìÖ', description: 'Registraste 10+ gastos', condition: () => state.expenses.length >= 10 }
        ];

        // ========== FUNCIONES DE FORMATO ==========
        function formatEuro(amount) {
            const num = parseFloat(amount).toFixed(2);
            const parts = num.split('.');
            const integerPart = parts[0];
            const decimalPart = parts[1];
            const formattedInteger = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            return formattedInteger + ',' + decimalPart + '‚Ç¨';
        }

        function formatEuroCompact(amount) {
            const num = Math.abs(parseFloat(amount));
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M‚Ç¨';
            } else if (num >= 10000) {
                return (num / 1000).toFixed(1) + 'K‚Ç¨';
            }
            return formatEuro(amount);
        }

        // ========== FUNCIONES DE MOTIVACI√ìN (TOAST) ==========
        function showMotivationToast(message, duration = 6000) {
            if (shownMotivations.has(message)) return;
            shownMotivations.add(message);
            
            const container = document.getElementById('motivationToasts');
            
            const toast = document.createElement('div');
            toast.className = 'motivation-toast';
            toast.innerHTML = `
                <div class="motivation-toast-content">
                    <button class="close-btn" onclick="closeMotivationToast(this.parentElement.parentElement)">‚úï</button>
                    <p class="text-sm text-blue-800 pr-4">${message}</p>
                    <div class="progress-bar-toast" style="width: 100%"></div>
                </div>
            `;
            
            container.appendChild(toast);
            
            const progressBar = toast.querySelector('.progress-bar-toast');
            let width = 100;
            const interval = setInterval(() => {
                width -= (100 / (duration / 100));
                progressBar.style.width = width + '%';
                if (width <= 0) clearInterval(interval);
            }, 100);
            
            setTimeout(() => closeMotivationToast(toast), duration);
        }
        
        function closeMotivationToast(toast) {
            if (!toast || toast.classList.contains('hiding')) return;
            toast.classList.add('hiding');
            setTimeout(() => toast.remove(), 300);
        }
        
        function showMotivationMessages() {
            const messages = getFinancialHealthMessage();
            if (messages.length > 0) {
                messages.forEach((msg, index) => {
                    setTimeout(() => showMotivationToast(msg, 6000), index * 2000);
                });
            }
        }

        // ========== FUNCIONES DE SUPABASE ==========
        async function initSupabase(url, anonKey) {
            if (!url || !anonKey) return false;
            
            try {
                if (!window.supabase) {
                    await loadScript('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2');
                }
                
                supabaseClient = window.supabase.createClient(url, anonKey);
                SUPABASE_CONFIG.url = url;
                SUPABASE_CONFIG.anonKey = anonKey;
                SUPABASE_CONFIG.initialized = true;
                isOnline = true;
                
                showNotification('‚úÖ Conectado a Supabase');
                return true;
            } catch (error) {
                console.error('Error inicializando Supabase:', error);
                isOnline = false;
                return false;
            }
        }

        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        async function saveToSupabase(table, data) {
            if (!supabaseClient) {
                syncQueue.push({ table, data, action: 'upsert' });
                saveDataLocal();
                return;
            }
            
            try {
                const { error } = await supabaseClient.from(table).upsert(data);
                if (error) throw error;
            } catch (error) {
                console.error('Error guardando en Supabase:', error);
                syncQueue.push({ table, data, action: 'upsert' });
            }
        }

        async function deleteFromSupabase(table, id) {
            if (!supabaseClient) {
                syncQueue.push({ table, id, action: 'delete' });
                saveDataLocal();
                return;
            }
            
            try {
                const { error } = await supabaseClient.from(table).delete().eq('id', id);
                if (error) throw error;
            } catch (error) {
                console.error('Error eliminando de Supabase:', error);
                syncQueue.push({ table, id, action: 'delete' });
            }
        }

        // ========== FUNCIONES DE UI ==========
        function toggleDarkMode() {
            state.darkMode = !state.darkMode;
            document.body.classList.toggle('dark-mode', state.darkMode);
            saveData();
        }

        // ========== FUNCIONES DE AUTENTICACI√ìN ==========
        async function handleLogin() {
            if (!authState.email || !authState.password) {
                authState.authError = 'Por favor, completa todos los campos';
                renderAuth();
                return;
            }
            
            authState.authError = '';
            authState.loading = true;
            renderAuth();
            
            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: authState.email,
                    password: authState.password
                });
                
                if (error) throw error;
                
                authState.isAuthenticated = true;
                authState.user = data.user;
                currentUser = data.user;
                state.userId = data.user.id;
                
                // Cargar datos del usuario
                await loadDataFromSupabasePublic();
                
                authState.loading = false;
                authState.email = '';
                authState.password = '';
                
                render();
                showNotification('‚úÖ ¬°Bienvenido de nuevo!');
            } catch (error) {
                authState.loading = false;
                authState.authError = getAuthErrorMessage(error.message);
                renderAuth();
            }
        }
        
        async function handleRegister() {
            if (!authState.email || !authState.password || !authState.confirmPassword) {
                authState.authError = 'Por favor, completa todos los campos';
                renderAuth();
                return;
            }
            
            if (authState.password !== authState.confirmPassword) {
                authState.authError = 'Las contrase√±as no coinciden';
                renderAuth();
                return;
            }
            
            if (authState.password.length < 6) {
                authState.authError = 'La contrase√±a debe tener al menos 6 caracteres';
                renderAuth();
                return;
            }
            
            authState.authError = '';
            authState.loading = true;
            renderAuth();
            
            try {
                const { data, error } = await supabaseClient.auth.signUp({
                    email: authState.email,
                    password: authState.password
                });
                
                if (error) throw error;
                
                authState.loading = false;
                authState.authSuccess = '‚úÖ Cuenta creada correctamente. Revisa tu email para confirmar.';
                authState.authView = 'login';
                authState.password = '';
                authState.confirmPassword = '';
                renderAuth();
            } catch (error) {
                authState.loading = false;
                authState.authError = getAuthErrorMessage(error.message);
                renderAuth();
            }
        }
        
        async function handleForgotPassword() {
            if (!authState.email) {
                authState.authError = 'Por favor, introduce tu email';
                renderAuth();
                return;
            }
            
            authState.authError = '';
            authState.loading = true;
            renderAuth();
            
            try {
                const { error } = await supabaseClient.auth.resetPasswordForEmail(authState.email, {
                    redirectTo: window.location.origin
                });
                
                if (error) throw error;
                
                authState.loading = false;
                authState.authSuccess = '‚úÖ Te hemos enviado un email para restablecer tu contrase√±a';
                authState.authView = 'login';
                renderAuth();
            } catch (error) {
                authState.loading = false;
                authState.authError = getAuthErrorMessage(error.message);
                renderAuth();
            }
        }
        
        async function handleLogout() {
            try {
                await supabaseClient.auth.signOut();
                authState.isAuthenticated = false;
                authState.user = null;
                currentUser = null;
                state.userId = null;
                
                // Limpiar datos locales
                state.expenses = [];
                state.savingsWithdrawals = [];
                state.savingsDeposits = [];
                state.debtors = [];
                state.loans = [];
                state.monthlyIncome = '';
                state.creditCardIncome = '';
                
                renderAuth();
                showNotification('üëã Sesi√≥n cerrada');
            } catch (error) {
                showNotification('‚ùå Error al cerrar sesi√≥n', true);
            }
        }
        
        function getAuthErrorMessage(message) {
            const errorMessages = {
                'Invalid login credentials': 'Email o contrase√±a incorrectos',
                'Email not confirmed': 'Por favor, confirma tu email antes de iniciar sesi√≥n',
                'User already registered': 'Este email ya est√° registrado',
                'Password should be at least 6 characters': 'La contrase√±a debe tener al menos 6 caracteres',
                'Unable to validate email address: invalid format': 'Formato de email inv√°lido',
                'Email rate limit exceeded': 'Demasiados intentos. Espera unos minutos.'
            };
            return errorMessages[message] || message;
        }
        
        function setAuthView(view) {
            authState.authView = view;
            authState.authError = '';
            authState.authSuccess = '';
            renderAuth();
        }
        
        function updateAuthField(field, value) {
            authState[field] = value;
        }
        
        // ========== RENDER DE AUTENTICACI√ìN ==========
        function renderAuth() {
            const app = document.getElementById('app');
            
            if (authState.loading && !authState.isAuthenticated) {
                app.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center">
                        <div class="text-center">
                            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
                            <p class="text-gray-500">Cargando...</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            let formContent = '';
            
            if (authState.authView === 'login') {
                formContent = `
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Iniciar Sesi√≥n</h2>
                    <p class="text-gray-500 text-sm mb-6">Accede a tu organizador de gastos</p>
                    
                    ${authState.authSuccess ? `<div class="mb-4 p-3 bg-green-50 border border-green-200 text-green-700 rounded-lg text-sm">${authState.authSuccess}</div>` : ''}
                    ${authState.authError ? `<div class="mb-4 p-3 bg-red-50 border border-red-200 text-red-700 rounded-lg text-sm">${authState.authError}</div>` : ''}
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input type="email" id="authEmail" value="${authState.email}" placeholder="tu@email.com" 
                                class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Contrase√±a</label>
                            <input type="password" id="authPassword" value="${authState.password}" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                                class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition" />
                        </div>
                        <button onclick="handleLogin()" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-xl font-medium transition transform hover:scale-[1.02] active:scale-[0.98]">
                            Entrar
                        </button>
                    </div>
                    
                    <div class="mt-6 text-center space-y-2">
                        <button onclick="setAuthView('forgot')" class="text-blue-500 hover:text-blue-600 text-sm">¬øOlvidaste tu contrase√±a?</button>
                        <p class="text-gray-500 text-sm">¬øNo tienes cuenta? <button onclick="setAuthView('register')" class="text-blue-500 hover:text-blue-600 font-medium">Reg√≠strate</button></p>
                    </div>
                `;
            } else if (authState.authView === 'register') {
                formContent = `
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Crear Cuenta</h2>
                    <p class="text-gray-500 text-sm mb-6">Empieza a organizar tus finanzas</p>
                    
                    ${authState.authError ? `<div class="mb-4 p-3 bg-red-50 border border-red-200 text-red-700 rounded-lg text-sm">${authState.authError}</div>` : ''}
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input type="email" id="authEmail" value="${authState.email}" placeholder="tu@email.com" 
                                class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Contrase√±a</label>
                            <input type="password" id="authPassword" value="${authState.password}" placeholder="M√≠nimo 6 caracteres" 
                                class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Confirmar Contrase√±a</label>
                            <input type="password" id="authConfirmPassword" value="${authState.confirmPassword}" placeholder="Repite la contrase√±a" 
                                class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition" />
                        </div>
                        <button onclick="handleRegister()" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white py-3 rounded-xl font-medium transition transform hover:scale-[1.02] active:scale-[0.98]">
                            Crear Cuenta
                        </button>
                    </div>
                    
                    <div class="mt-6 text-center">
                        <p class="text-gray-500 text-sm">¬øYa tienes cuenta? <button onclick="setAuthView('login')" class="text-blue-500 hover:text-blue-600 font-medium">Inicia sesi√≥n</button></p>
                    </div>
                `;
            } else if (authState.authView === 'forgot') {
                formContent = `
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Recuperar Contrase√±a</h2>
                    <p class="text-gray-500 text-sm mb-6">Te enviaremos un email para restablecerla</p>
                    
                    ${authState.authError ? `<div class="mb-4 p-3 bg-red-50 border border-red-200 text-red-700 rounded-lg text-sm">${authState.authError}</div>` : ''}
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input type="email" id="authEmail" value="${authState.email}" placeholder="tu@email.com" 
                                class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition" />
                        </div>
                        <button onclick="handleForgotPassword()" class="w-full bg-violet-500 hover:bg-violet-600 text-white py-3 rounded-xl font-medium transition transform hover:scale-[1.02] active:scale-[0.98]">
                            Enviar Email
                        </button>
                    </div>
                    
                    <div class="mt-6 text-center">
                        <button onclick="setAuthView('login')" class="text-blue-500 hover:text-blue-600 text-sm">‚Üê Volver al login</button>
                    </div>
                `;
            }
            
            app.innerHTML = `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="w-full max-w-md">
                        <div class="text-center mb-8">
                            <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-emerald-500 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                                <span class="text-4xl">üí∞</span>
                            </div>
                            <h1 class="text-3xl font-bold text-gray-800">Organizador de Gastos</h1>
                        </div>
                        
                        <div class="bg-white rounded-2xl shadow-xl p-8 border border-gray-100">
                            ${formContent}
                        </div>
                        
                        <p class="text-center text-gray-400 text-xs mt-6">Tus datos est√°n seguros y encriptados</p>
                    </div>
                </div>
            `;
            
            // Event listeners para los campos de autenticaci√≥n
            const emailInput = document.getElementById('authEmail');
            const passwordInput = document.getElementById('authPassword');
            const confirmPasswordInput = document.getElementById('authConfirmPassword');
            
            if (emailInput) {
                emailInput.addEventListener('input', (e) => updateAuthField('email', e.target.value));
                emailInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        if (authState.authView === 'login') handleLogin();
                        else if (authState.authView === 'forgot') handleForgotPassword();
                    }
                });
            }
            if (passwordInput) {
                passwordInput.addEventListener('input', (e) => updateAuthField('password', e.target.value));
                passwordInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && authState.authView === 'login') handleLogin();
                });
            }
            if (confirmPasswordInput) {
                confirmPasswordInput.addEventListener('input', (e) => updateAuthField('confirmPassword', e.target.value));
                confirmPasswordInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && authState.authView === 'register') handleRegister();
                });
            }
        }

        function toggleSection(section) {
            state[section] = !state[section];
            const element = document.getElementById(section);
            const button = document.getElementById(section + 'Btn');
            if (element && button) {
                element.classList.toggle('open');
                button.classList.toggle('open');
            }
        }

        function setTimeFilter(filter) {
            state.timeFilter = filter;
            render();
        }

        function getFilteredExpenses() {
            const now = new Date();
            let startDate;

            switch(state.timeFilter) {
                case 'week':
                    startDate = new Date(now.setDate(now.getDate() - 7));
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    break;
                case 'year':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    break;
                default:
                    return state.expenses;
            }

            return state.expenses.filter(exp => new Date(exp.date) >= startDate);
        }

        // ========== FUNCIONES DE DATOS LOCALES ==========
        function loadData() {
            const savedData = localStorage.getItem('expenseTrackerData');
            if (savedData) {
                const data = JSON.parse(savedData);
                state.expenses = data.expenses || [];
                state.savingsWithdrawals = data.savingsWithdrawals || [];
                state.savingsDeposits = data.savingsDeposits || [];
                state.debtors = data.debtors || [];
                state.loans = data.loans || [];
                state.monthlyIncome = data.monthlyIncome || '';
                state.creditCardIncome = data.creditCardIncome || '';
                state.owedMoney = data.owedMoney || '';
                state.projectionMonths = data.projectionMonths || '';
                state.monthlySavingsPlan = data.monthlySavingsPlan || '';
                state.darkMode = data.darkMode || false;
                state.badges = data.badges || [];
                state.lastMonthSavings = data.lastMonthSavings || 0;
                syncQueue = data.syncQueue || [];
            }
            document.body.classList.toggle('dark-mode', state.darkMode);
            checkBadges();
            render();
        }

        function saveDataLocal() {
            const dataToSave = {
                expenses: state.expenses,
                savingsWithdrawals: state.savingsWithdrawals,
                savingsDeposits: state.savingsDeposits,
                debtors: state.debtors,
                loans: state.loans,
                monthlyIncome: state.monthlyIncome,
                creditCardIncome: state.creditCardIncome,
                owedMoney: state.owedMoney,
                projectionMonths: state.projectionMonths,
                monthlySavingsPlan: state.monthlySavingsPlan,
                darkMode: state.darkMode,
                badges: state.badges,
                lastMonthSavings: state.lastMonthSavings,
                syncQueue: syncQueue,
                lastSaved: new Date().toISOString()
            };
            localStorage.setItem('expenseTrackerData', JSON.stringify(dataToSave));
        }

        function saveData() {
            saveDataLocal();
            
            if (supabaseClient && state.userId) {
                saveToSupabase('user_config', {
                    user_id: state.userId,
                    monthly_income: parseFloat(state.monthlyIncome) || 0,
                    credit_card_income: parseFloat(state.creditCardIncome) || 0,
                    projection_months: parseInt(state.projectionMonths) || 0,
                    monthly_savings_plan: parseFloat(state.monthlySavingsPlan) || 0,
                    dark_mode: state.darkMode,
                    badges: state.badges
                });
            }
            
            showNotification('‚úÖ Datos guardados correctamente');
        }

        function exportData() {
            const dataToExport = {
                expenses: state.expenses,
                savingsWithdrawals: state.savingsWithdrawals,
                debtors: state.debtors,
                monthlyIncome: state.monthlyIncome,
                creditCardIncome: state.creditCardIncome,
                owedMoney: state.owedMoney,
                projectionMonths: state.projectionMonths,
                monthlySavingsPlan: state.monthlySavingsPlan,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `gastos_backup_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            showNotification('üì• Archivo descargado correctamente');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    state.expenses = data.expenses || [];
                    state.savingsWithdrawals = data.savingsWithdrawals || [];
                    state.debtors = data.debtors || [];
                    state.monthlyIncome = data.monthlyIncome || '';
                    state.creditCardIncome = data.creditCardIncome || '';
                    state.owedMoney = data.owedMoney || '';
                    state.projectionMonths = data.projectionMonths || '';
                    state.monthlySavingsPlan = data.monthlySavingsPlan || '';
                    
                    saveData();
                    render();
                    showNotification('‚úÖ Datos importados correctamente');
                } catch (error) {
                    showNotification('‚ùå Error al importar archivo', true);
                }
            };
            reader.readAsText(file);
        }

        function showNotification(message, isError = false) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white font-medium z-50 animate-slide-in ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function checkBadges() {
            badgeDefinitions.forEach(badge => {
                if (badge.condition() && !state.badges.includes(badge.id)) {
                    state.badges.push(badge.id);
                    showNotification(`üéâ ¬°Nuevo logro desbloqueado: ${badge.name}!`);
                }
            });
        }

        function checkNoDaysNoLuxury(days) {
            if (state.expenses.length === 0) return false;
            const luxuryCategories = ['üéÆ Entretenimiento', 'üçï Restaurantes', 'üõçÔ∏è Compras', '‚úàÔ∏è Viajes'];
            const now = new Date();
            const daysAgo = new Date(now.setDate(now.getDate() - days));
            
            const recentLuxury = state.expenses.filter(exp => 
                luxuryCategories.includes(exp.category) && new Date(exp.date) >= daysAgo
            );
            
            return recentLuxury.length === 0 && state.expenses.some(exp => new Date(exp.date) >= daysAgo);
        }

        // ========== FUNCIONES DE GASTOS ==========
        function addExpense() {
            if (!state.description || !state.amount || parseFloat(state.amount) <= 0) {
                showNotification('‚ùå Completa todos los campos correctamente', true);
                return;
            }

            if (state.editingExpenseId) {
                const index = state.expenses.findIndex(exp => exp.id === state.editingExpenseId);
                if (index !== -1) {
                    const updatedExpense = {
                        id: state.editingExpenseId,
                        user_id: state.userId,
                        description: state.description,
                        amount: parseFloat(state.amount),
                        category: state.category,
                        date: state.date
                    };
                    state.expenses[index] = updatedExpense;
                    saveToSupabase('expenses', updatedExpense);
                    showNotification('‚úÖ Gasto actualizado');
                }
                state.editingExpenseId = null;
            } else {
                const newExpense = {
                    id: Date.now(),
                    user_id: state.userId,
                    description: state.description,
                    amount: parseFloat(state.amount),
                    category: state.category,
                    date: state.date
                };
                state.expenses.unshift(newExpense);
                saveToSupabase('expenses', newExpense);
                showNotification('‚úÖ Gasto a√±adido');
            }

            state.description = '';
            state.amount = '';
            state.date = new Date().toISOString().split('T')[0];
            
            checkBadges();
            saveDataLocal();
            render();
        }

        function editExpense(id) {
            const expense = state.expenses.find(exp => exp.id === id);
            if (expense) {
                state.editingExpenseId = id;
                state.description = expense.description;
                state.amount = expense.amount.toString();
                state.category = expense.category;
                state.date = expense.date;
                render();
                setTimeout(() => {
                    document.getElementById('description').scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
            }
        }

        function cancelEdit() {
            state.editingExpenseId = null;
            state.description = '';
            state.amount = '';
            state.category = 'üçé Alimentaci√≥n';
            state.date = new Date().toISOString().split('T')[0];
            render();
        }

        function deleteExpense(id) {
            state.expenses = state.expenses.filter(exp => exp.id !== id);
            deleteFromSupabase('expenses', id);
            checkBadges();
            saveDataLocal();
            render();
            showNotification('üóëÔ∏è Gasto eliminado');
        }

        // ========== FUNCIONES DE C√ÅLCULO ==========
        function getCategoryType(catName) {
            const cat = categories.find(c => c.name === catName);
            return cat ? cat.type : 'otros';
        }

        function getTotalByType() {
            const totals = { esencial: 0, salida: 0, ahorro: 0, bizum: 0, suscripcion: 0, otros: 0 };
            const filtered = getFilteredExpenses();
            filtered.forEach(exp => {
                const type = getCategoryType(exp.category);
                totals[type] += exp.amount;
            });
            return totals;
        }

        function getTotalByCategory() {
            const totals = {};
            const filtered = getFilteredExpenses();
            categories.forEach(cat => {
                totals[cat.name] = filtered
                    .filter(exp => exp.category === cat.name)
                    .reduce((sum, exp) => sum + exp.amount, 0);
            });
            return totals;
        }

        function getTotalMonth() {
            return getFilteredExpenses().reduce((sum, exp) => sum + exp.amount, 0);
        }

        function getTotalIncome() {
            return (parseFloat(state.monthlyIncome) || 0) + (parseFloat(state.creditCardIncome) || 0);
        }

        function getTotalWithdrawals() {
            return state.savingsWithdrawals.reduce((sum, withdrawal) => sum + withdrawal.amount, 0);
        }

        function getTotalDeposits() {
            return state.savingsDeposits.reduce((sum, deposit) => sum + deposit.amount, 0);
        }

        function getNetSavings() {
            const typeTotals = getTotalByType();
            return typeTotals.ahorro + getTotalDeposits() - getTotalWithdrawals();
        }

        // ========== FUNCIONES DE RETIROS ==========
        function addWithdrawal() {
            if (!state.withdrawalDescription || !state.withdrawalAmount || parseFloat(state.withdrawalAmount) <= 0) {
                showNotification('‚ùå Completa todos los campos correctamente', true);
                return;
            }

            const totalSavings = getTotalByType().ahorro;
            const currentWithdrawals = getTotalWithdrawals();
            const availableSavings = totalSavings - currentWithdrawals;

            if (parseFloat(state.withdrawalAmount) > availableSavings) {
                showNotification('‚ùå No tienes suficiente ahorro disponible', true);
                return;
            }

            const newWithdrawal = {
                id: Date.now(),
                user_id: state.userId,
                description: state.withdrawalDescription,
                amount: parseFloat(state.withdrawalAmount),
                date: new Date().toISOString().split('T')[0]
            };

            state.savingsWithdrawals.unshift(newWithdrawal);
            saveToSupabase('savings_withdrawals', newWithdrawal);
            state.withdrawalDescription = '';
            state.withdrawalAmount = '';
            
            saveDataLocal();
            render();
            showNotification('‚úÖ Retiro registrado');
        }

        function deleteWithdrawal(id) {
            state.savingsWithdrawals = state.savingsWithdrawals.filter(w => w.id !== id);
            deleteFromSupabase('savings_withdrawals', id);
            saveDataLocal();
            render();
            showNotification('üóëÔ∏è Retiro eliminado');
        }

        // ========== FUNCIONES DE DEP√ìSITOS DE AHORRO ==========
        function addDeposit() {
            if (!state.depositDescription || !state.depositAmount || parseFloat(state.depositAmount) <= 0) {
                showNotification('‚ùå Completa todos los campos correctamente', true);
                return;
            }

            const newDeposit = {
                id: Date.now(),
                user_id: state.userId,
                description: state.depositDescription,
                amount: parseFloat(state.depositAmount),
                date: new Date().toISOString().split('T')[0]
            };

            state.savingsDeposits.unshift(newDeposit);
            saveToSupabase('savings_deposits', newDeposit);
            state.depositDescription = '';
            state.depositAmount = '';
            
            checkBadges();
            saveDataLocal();
            render();
            showNotification('‚úÖ Ingreso registrado');
        }

        function deleteDeposit(id) {
            state.savingsDeposits = state.savingsDeposits.filter(d => d.id !== id);
            deleteFromSupabase('savings_deposits', id);
            saveDataLocal();
            render();
            showNotification('üóëÔ∏è Ingreso eliminado');
        }

        // ========== FUNCIONES DE DEUDORES ==========
        function getTotalOwed() {
            return state.debtors.reduce((sum, debtor) => sum + debtor.amount, 0);
        }

        function addDebtor() {
            if (!state.debtorName || !state.debtorAmount || parseFloat(state.debtorAmount) <= 0) {
                showNotification('‚ùå Completa todos los campos correctamente', true);
                return;
            }

            const newDebtor = {
                id: Date.now(),
                user_id: state.userId,
                name: state.debtorName,
                amount: parseFloat(state.debtorAmount),
                date: new Date().toISOString().split('T')[0]
            };

            state.debtors.unshift(newDebtor);
            saveToSupabase('debtors', newDebtor);
            state.debtorName = '';
            state.debtorAmount = '';
            
            saveDataLocal();
            render();
            showNotification('‚úÖ Deudor a√±adido');
        }

        function deleteDebtor(id) {
            state.debtors = state.debtors.filter(d => d.id !== id);
            deleteFromSupabase('debtors', id);
            saveDataLocal();
            render();
            showNotification('üóëÔ∏è Deudor eliminado');
        }

        function remindDebtorWhatsApp(name, amount) {
            const message = `Hola ${name}, te recuerdo que me debes ${formatEuro(amount)}. ¬°Gracias! üòä`;
            const url = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
        }

        // ========== FUNCIONES DE PR√âSTAMOS ==========
        function getTotalLoans() {
            return state.loans.reduce((sum, loan) => sum + loan.pendingAmount, 0);
        }

        function getTotalMonthlyLoanPayments() {
            const currentMonth = new Date().toISOString().slice(0, 7);
            return state.loans.reduce((sum, loan) => {
                if (loan.startDate && loan.startDate > currentMonth) return sum;
                return sum + loan.monthlyPayment;
            }, 0);
        }

        function isLoanActive(loan) {
            if (!loan.startDate) return true;
            const currentMonth = new Date().toISOString().slice(0, 7);
            return loan.startDate <= currentMonth;
        }

        function addLoan() {
            if (!state.loanName || !state.loanAmount || !state.loanMonths || 
                parseFloat(state.loanAmount) <= 0 || parseInt(state.loanMonths) <= 0) {
                showNotification('‚ùå Completa todos los campos correctamente', true);
                return;
            }

            const totalAmount = parseFloat(state.loanAmount);
            const months = parseInt(state.loanMonths);
            const paidAmount = parseFloat(state.loanPaid) || 0;
            const pendingAmount = totalAmount - paidAmount;
            const remainingMonths = Math.ceil(pendingAmount / (totalAmount / months));
            const monthlyPayment = pendingAmount / remainingMonths;
            const startDate = state.loanStartDate || new Date().toISOString().slice(0, 7);

            const newLoan = {
                id: Date.now(),
                user_id: state.userId,
                name: state.loanName,
                totalAmount: totalAmount,
                pendingAmount: pendingAmount,
                paidAmount: paidAmount,
                totalMonths: months,
                remainingMonths: remainingMonths,
                monthlyPayment: monthlyPayment,
                startDate: startDate,
                date: new Date().toISOString().split('T')[0]
            };

            state.loans.unshift(newLoan);
            
            saveToSupabase('loans', {
                id: newLoan.id,
                user_id: state.userId,
                name: newLoan.name,
                total_amount: newLoan.totalAmount,
                pending_amount: newLoan.pendingAmount,
                paid_amount: newLoan.paidAmount,
                total_months: newLoan.totalMonths,
                remaining_months: newLoan.remainingMonths,
                monthly_payment: newLoan.monthlyPayment,
                start_date: newLoan.startDate,
                date: newLoan.date
            });
            
            state.loanName = '';
            state.loanAmount = '';
            state.loanMonths = '';
            state.loanPaid = '';
            state.loanStartDate = '';
            
            saveDataLocal();
            render();
            
            showNotification(isLoanActive(newLoan) ? '‚úÖ Pr√©stamo a√±adido' : `‚úÖ Pr√©stamo programado para ${newLoan.startDate}`);
        }

        function payLoan(id, amount) {
            const loan = state.loans.find(l => l.id === id);
            if (!loan) return;

            if (!isLoanActive(loan)) {
                showNotification('‚ùå Este pr√©stamo no est√° activo a√∫n', true);
                return;
            }

            const paymentAmount = parseFloat(amount) || loan.monthlyPayment;
            
            if (paymentAmount > loan.pendingAmount) {
                showNotification('‚ùå El pago excede la deuda pendiente', true);
                return;
            }

            loan.paidAmount += paymentAmount;
            loan.pendingAmount -= paymentAmount;
            
            if (loan.pendingAmount <= 0) {
                loan.pendingAmount = 0;
                loan.remainingMonths = 0;
                showNotification('üéâ ¬°Pr√©stamo liquidado!');
            } else {
                loan.remainingMonths = Math.ceil(loan.pendingAmount / loan.monthlyPayment);
                showNotification('‚úÖ Pago registrado');
            }

            saveToSupabase('loans', {
                id: loan.id, user_id: state.userId, name: loan.name, total_amount: loan.totalAmount,
                pending_amount: loan.pendingAmount, paid_amount: loan.paidAmount,
                total_months: loan.totalMonths, remaining_months: loan.remainingMonths,
                monthly_payment: loan.monthlyPayment, start_date: loan.startDate, date: loan.date
            });
            
            saveDataLocal();
            render();
        }

        function deleteLoan(id) {
            state.loans = state.loans.filter(l => l.id !== id);
            deleteFromSupabase('loans', id);
            saveDataLocal();
            render();
            showNotification('üóëÔ∏è Pr√©stamo eliminado');
        }

        function amortizeLoan(id) {
            const input = document.getElementById(`amortize-${id}`);
            const amount = parseFloat(input?.value) || 0;
            
            if (amount <= 0) {
                showNotification('‚ùå Introduce una cantidad v√°lida', true);
                return;
            }
            
            const loan = state.loans.find(l => l.id === id);
            if (!loan || amount > loan.pendingAmount) {
                showNotification('‚ùå La cantidad excede la deuda pendiente', true);
                return;
            }
            
            loan.paidAmount += amount;
            loan.pendingAmount -= amount;
            
            if (loan.pendingAmount <= 0) {
                loan.pendingAmount = 0;
                loan.remainingMonths = 0;
                loan.monthlyPayment = 0;
                showNotification('üéâ ¬°Pr√©stamo liquidado!');
            } else {
                loan.remainingMonths = Math.ceil(loan.pendingAmount / loan.monthlyPayment);
                showNotification(`‚úÖ Amortizaci√≥n de ${formatEuro(amount)} realizada`);
            }
            
            saveToSupabase('loans', {
                id: loan.id, user_id: state.userId, name: loan.name, total_amount: loan.totalAmount,
                pending_amount: loan.pendingAmount, paid_amount: loan.paidAmount,
                total_months: loan.totalMonths, remaining_months: loan.remainingMonths,
                monthly_payment: loan.monthlyPayment, start_date: loan.startDate, date: loan.date
            });
            
            saveDataLocal();
            render();
        }

        function amortizeLoanFull(id) {
            const loan = state.loans.find(l => l.id === id);
            if (!loan) return;
            
            if (!confirm(`¬øLiquidar completamente "${loan.name}" por ${formatEuro(loan.pendingAmount)}?`)) return;
            
            loan.paidAmount = loan.totalAmount;
            loan.pendingAmount = 0;
            loan.remainingMonths = 0;
            loan.monthlyPayment = 0;
            
            saveToSupabase('loans', {
                id: loan.id, user_id: state.userId, name: loan.name, total_amount: loan.totalAmount,
                pending_amount: loan.pendingAmount, paid_amount: loan.paidAmount,
                total_months: loan.totalMonths, remaining_months: loan.remainingMonths,
                monthly_payment: loan.monthlyPayment, start_date: loan.startDate, date: loan.date
            });
            
            saveDataLocal();
            render();
            showNotification('üéâ ¬°Pr√©stamo liquidado completamente!');
        }

        // ========== FUNCIONES DE PROYECCIONES ==========
        function calculateProjections() {
            const months = parseFloat(state.projectionMonths) || 0;
            const monthlySavings = parseFloat(state.monthlySavingsPlan) || 0;
            const currentSavings = getNetSavings();
            const owed = getTotalOwed();
            const remainingBalance = getTotalIncome() - getTotalMonth() - getTotalMonthlyLoanPayments();
            
            const validMonthlySavings = monthlySavings <= remainingBalance ? monthlySavings : remainingBalance;
            
            const projectionFromZero = validMonthlySavings * months;
            const projectionWithCurrent = currentSavings + projectionFromZero;
            const projectionWithOwed = projectionWithCurrent + owed;
            
            return { fromZero: projectionFromZero, withCurrent: projectionWithCurrent, withoutOwed: projectionWithCurrent, withOwed: projectionWithOwed, validMonthlySavings };
        }

        function getFinancialHealthMessage() {
            const netSavings = getNetSavings();
            const totalIncome = getTotalIncome();
            const savingsRate = totalIncome > 0 ? (netSavings / totalIncome) * 100 : 0;
            const typeTotals = getTotalByType();
            
            let messages = [];
            
            if (savingsRate >= 20) {
                messages.push('üåü ¬°Excelente! Est√°s ahorrando m√°s del 20% de tus ingresos');
            } else if (savingsRate >= 10) {
                messages.push('üëç Buen trabajo, est√°s ahorrando un ' + savingsRate.toFixed(1) + '%');
            } else if (savingsRate > 0) {
                messages.push('‚ö†Ô∏è Intenta aumentar tu tasa de ahorro (actual: ' + savingsRate.toFixed(1) + '%)');
            } else if (totalIncome > 0) {
                messages.push('‚ùó No est√°s ahorrando este mes. ¬°Intenta guardar algo!');
            }
            
            if (typeTotals.salida > totalIncome * 0.3) {
                messages.push('üí° Tus gastos en salidas superan el 30% de tus ingresos');
            }
            
            if (state.lastMonthSavings > 0 && netSavings > state.lastMonthSavings) {
                const increase = ((netSavings - state.lastMonthSavings) / state.lastMonthSavings * 100).toFixed(1);
                messages.push(`üìà ¬°Has ahorrado un ${increase}% m√°s que el mes pasado!`);
            }
            
            return messages;
        }

        // ========== GR√ÅFICO ==========
        let chartInstance = null;
        function renderChart() {
            const ctx = document.getElementById('expenseChart');
            if (!ctx) return;
            
            const totals = getTotalByCategory();
            const labels = [];
            const data = [];
            const colors = [];
            
            const colorPalette = [
                '#10b981', '#3b82f6', '#8b5cf6', '#ec4899', '#ef4444',
                '#f59e0b', '#f97316', '#d946ef', '#06b6d4', '#14b8a6',
                '#6366f1', '#8b5cf6', '#64748b', '#475569'
            ];
            
            categories.forEach((cat, idx) => {
                if (totals[cat.name] > 0) {
                    labels.push(cat.displayName);
                    data.push(totals[cat.name]);
                    colors.push(colorPalette[idx % colorPalette.length]);
                }
            });
            
            if (chartInstance) chartInstance.destroy();
            
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{ data: data, backgroundColor: colors, borderWidth: 2, borderColor: '#fff' }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { padding: 10, font: { size: 10 } } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${context.label}: ${formatEuro(value)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateTotalsOnly() {
            const monthTotal = getTotalMonth();
            const monthlyLoanPayments = getTotalMonthlyLoanPayments();
            const remainingBalance = getTotalIncome() - monthTotal - monthlyLoanPayments;

            const saldoElement = document.querySelector('.saldo-display');
            if (saldoElement) {
                saldoElement.className = `saldo-display amount-display-large font-bold ${remainingBalance >= 0 ? 'text-emerald-600' : 'text-red-600'}`;
                saldoElement.textContent = formatEuro(remainingBalance);
            }
        }

        // ========== RENDER DE BADGES ==========
        function renderBadges() {
            const earnedBadges = badgeDefinitions.filter(b => state.badges.includes(b.id));
            if (earnedBadges.length === 0) return '';
            
            return `
                <div class="flex gap-2 flex-wrap">
                    ${earnedBadges.map(badge => `
                        <div class="badge-item">
                            <span class="badge-icon">${badge.icon}</span>
                            <span>${badge.name}</span>
                            <div class="badge-tooltip">${badge.description}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // ========== RENDER PRINCIPAL ==========
        function render() {
            const typeTotals = getTotalByType();
            const totals = getTotalByCategory();
            const monthTotal = getTotalMonth();
            const totalLoans = getTotalLoans();
            const monthlyLoanPayments = getTotalMonthlyLoanPayments();
            const remainingBalance = getTotalIncome() - monthTotal - monthlyLoanPayments;
            const projections = calculateProjections();
            const earnedBadges = badgeDefinitions.filter(b => state.badges.includes(b.id));
            const hasExpenses = Object.values(totals).some(v => v > 0);

            const app = document.getElementById('app');
            app.innerHTML = `
                <!-- Header Compacto -->
                <div class="header-card rounded-2xl shadow-sm p-4 mb-4 animate-slide-in">
                    <!-- Fila 1: T√≠tulo + Estado -->
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2 min-w-0 flex-1">
                            <h1 class="text-lg md:text-2xl font-bold text-gray-800 truncate">üí∞ Organizador de Gastos</h1>
                            <div class="connection-status ${isOnline ? 'online' : 'offline'} flex-shrink-0">
                                <span class="connection-dot ${isOnline ? 'online' : 'offline'}"></span>
                                <span class="hidden sm:inline">${isOnline ? 'Sync' : 'Local'}</span>
                            </div>
                        </div>
                        ${authState.user ? `
                            <div class="hidden md:flex items-center gap-2 px-3 py-1.5 bg-gray-50 rounded-lg flex-shrink-0">
                                <span class="text-xs text-gray-500">üë§</span>
                                <span class="text-xs text-gray-600 font-medium truncate max-w-[150px]">${authState.user.email}</span>
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Fila 2: Botones - 2 en 2 en m√≥vil, todos en fila en escritorio -->
                    <div class="flex flex-wrap gap-2 mb-4 sm:flex-nowrap">
                        <button onclick="toggleDarkMode()" class="action-btn-mobile sm:action-btn bg-gray-100 hover:bg-gray-200">${state.darkMode ? '‚òÄÔ∏è' : 'üåô'}</button>
                        <button onclick="saveData()" class="action-btn-mobile sm:action-btn bg-emerald-500 hover:bg-emerald-600 text-white">üíæ</button>
                        <button onclick="exportData()" class="action-btn-mobile sm:action-btn bg-blue-500 hover:bg-blue-600 text-white">üì•</button>
                        <label class="action-btn-mobile sm:action-btn bg-violet-500 hover:bg-violet-600 text-white cursor-pointer">
                            üì§
                            <input type="file" accept=".json" onchange="importData(event)" class="hidden" />
                        </label>
                        <button onclick="handleLogout()" class="action-btn-mobile sm:action-btn bg-red-500 hover:bg-red-600 text-white" title="Cerrar sesi√≥n">üö™</button>
                    </div>
                    
                    <!-- Fila 2: Filtros + Badges -->
                    <div class="flex flex-wrap items-center gap-4 mb-4">
                        <div class="flex gap-2">
                            <button onclick="setTimeFilter('week')" class="time-filter px-3 py-1.5 rounded-lg text-xs ${state.timeFilter === 'week' ? 'time-filter-active' : 'text-gray-600'}">Semana</button>
                            <button onclick="setTimeFilter('month')" class="time-filter px-3 py-1.5 rounded-lg text-xs ${state.timeFilter === 'month' ? 'time-filter-active' : 'text-gray-600'}">Mes</button>
                            <button onclick="setTimeFilter('year')" class="time-filter px-3 py-1.5 rounded-lg text-xs ${state.timeFilter === 'year' ? 'time-filter-active' : 'text-gray-600'}">A√±o</button>
                        </div>
                        
                        ${earnedBadges.length > 0 ? `
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-gray-400">üèÜ ${earnedBadges.length}/${badgeDefinitions.length}</span>
                                ${renderBadges()}
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Fila 3: Inputs de Ingresos -->
                    <div class="grid grid-cols-3 gap-3">
                        <div class="income-card">
                            <label class="text-xs text-gray-400 block mb-1">üíµ Ingresos</label>
                            <input type="number" id="monthlyIncome" value="${state.monthlyIncome}" placeholder="0,00‚Ç¨" step="0.01" />
                        </div>
                        <div class="income-card">
                            <label class="text-xs text-gray-400 block mb-1">üéÅ Donaciones</label>
                            <input type="number" id="creditCardIncome" value="${state.creditCardIncome}" placeholder="0,00‚Ç¨" step="0.01" />
                        </div>
                        <div class="income-card" style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border-color: #a7f3d0;">
                            <label class="text-xs text-emerald-600 block mb-1">ü§ù Me deben</label>
                            <div class="text-lg font-bold text-emerald-700">${formatEuro(getTotalOwed())}</div>
                        </div>
                    </div>
                </div>

                <!-- Tarjetas de Totales -->
                <div class="totals-grid mb-4">
                    <div class="total-card rounded-xl p-4 border-l-4 border-blue-500 animate-slide-in col-span-2 md:col-span-1">
                        <p class="text-gray-500 text-xs mb-1">Saldo Disponible</p>
                        <p class="saldo-display amount-display-large ${remainingBalance >= 0 ? 'text-emerald-600' : 'text-red-600'}">${formatEuro(remainingBalance)}</p>
                        ${monthlyLoanPayments > 0 ? `<p class="text-xs text-gray-400 mt-1">-${formatEuro(monthlyLoanPayments)} pr√©stamos</p>` : ''}
                    </div>

                    <div class="total-card rounded-xl p-3 border-l-4 border-green-400 animate-slide-in cursor-pointer hover:bg-green-50 transition" onclick="showExpensesByType('esencial', 'Esenciales')">
                        <p class="text-gray-400 text-xs">Esenciales</p>
                        <p class="amount-display text-gray-800">${formatEuro(typeTotals.esencial)}</p>
                    </div>

                    <div class="total-card rounded-xl p-3 border-l-4 border-pink-400 animate-slide-in cursor-pointer hover:bg-pink-50 transition" onclick="showExpensesByType('salida', 'Salidas')">
                        <p class="text-gray-400 text-xs">Salidas</p>
                        <p class="amount-display text-gray-800">${formatEuro(typeTotals.salida)}</p>
                    </div>

                    <div class="total-card rounded-xl p-3 border-l-4 border-emerald-400 animate-slide-in cursor-pointer hover:bg-emerald-50 transition" onclick="showSavingsDetail()">
                        <p class="text-gray-400 text-xs">Ahorro Neto</p>
                        <p class="amount-display text-emerald-600">${formatEuro(getNetSavings())}</p>
                    </div>

                    <div class="total-card rounded-xl p-3 border-l-4 border-indigo-400 animate-slide-in cursor-pointer hover:bg-indigo-50 transition" onclick="showExpensesByType('bizum', 'Bizums')">
                        <p class="text-gray-400 text-xs">Bizums</p>
                        <p class="amount-display text-gray-800">${formatEuro(typeTotals.bizum)}</p>
                    </div>

                    <div class="total-card rounded-xl p-3 border-l-4 border-violet-400 animate-slide-in cursor-pointer hover:bg-violet-50 transition" onclick="showExpensesByType('suscripcion', 'Suscripciones')">
                        <p class="text-gray-400 text-xs">Suscrip.</p>
                        <p class="amount-display text-gray-800">${formatEuro(typeTotals.suscripcion)}</p>
                    </div>

                    <div class="total-card rounded-xl p-3 border-l-4 border-orange-400 animate-slide-in cursor-pointer hover:bg-orange-50 transition" onclick="showLoansDetail()">
                        <p class="text-gray-400 text-xs">Pr√©stamos</p>
                        <p class="amount-display text-orange-600">${formatEuro(totalLoans)}</p>
                    </div>
                </div>
                
                <!-- Modal de detalles -->
                <div id="detailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="closeDetailModal(event)">
                    <div class="bg-white rounded-2xl max-w-lg w-full max-h-[80vh] overflow-hidden shadow-2xl" onclick="event.stopPropagation()">
                        <div class="p-4 border-b border-gray-100 flex justify-between items-center">
                            <h3 id="modalTitle" class="text-lg font-semibold text-gray-800"></h3>
                            <button onclick="closeDetailModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                        </div>
                        <div id="modalContent" class="p-4 overflow-y-auto max-h-[60vh] custom-scroll"></div>
                    </div>
                </div>

                <!-- ========== NUEVA FILA: Formulario | Distribuci√≥n | Historial ========== -->
                <div class="grid md:grid-cols-3 gap-4 mb-4">
                    <!-- Formulario -->
                    <div class="bg-white rounded-xl p-4 sm:p-5 card animate-slide-in border ${state.editingExpenseId ? 'border-amber-300 ring-2 ring-amber-100' : 'border-gray-100'} overflow-hidden">
                        <h2 class="text-base font-semibold text-gray-800 mb-4">${state.editingExpenseId ? '‚úèÔ∏è Editar Gasto' : '‚ûï Nuevo Gasto'}</h2>
                        <div class="space-y-3">
                            <input type="text" id="description" value="${state.description}" placeholder="Descripci√≥n" class="w-full px-3 py-2.5 border border-gray-200 rounded-lg transition text-sm box-border" />
                            <div class="grid grid-cols-2 gap-2 sm:gap-3 w-full">
                                <input type="number" id="amount" value="${state.amount}" placeholder="0.00" step="0.01" class="w-full px-3 py-2.5 border border-gray-200 rounded-lg transition text-sm box-border" />
                                <input type="date" id="date" value="${state.date}" class="w-full px-2 py-2.5 border border-gray-200 rounded-lg transition text-sm box-border overflow-hidden" style="min-width: 0; max-width: 100%;" />
                            </div>
                            <select id="category" class="w-full px-3 py-2.5 border border-gray-200 rounded-lg transition text-sm box-border">
                                ${categories.map(cat => `<option value="${cat.name}" ${state.category === cat.name ? 'selected' : ''}>${cat.name}</option>`).join('')}
                            </select>
                            <div class="flex gap-2">
                                <button onclick="addExpense()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2.5 rounded-lg transition text-sm">
                                    ${state.editingExpenseId ? '‚úì Actualizar' : '+ Agregar'}
                                </button>
                                ${state.editingExpenseId ? `<button onclick="cancelEdit()" class="px-4 bg-gray-200 hover:bg-gray-300 text-gray-700 py-2.5 rounded-lg transition text-sm">‚úï</button>` : ''}
                            </div>
                        </div>
                    </div>

                    <!-- Gr√°fico de Distribuci√≥n -->
                    <div class="bg-white rounded-xl p-5 card animate-slide-in border border-gray-100">
                        <h2 class="text-base font-semibold text-gray-800 mb-3">üìä Distribuci√≥n</h2>
                        ${hasExpenses ? `
                            <div style="height: 220px; position: relative;">
                                <canvas id="expenseChart"></canvas>
                            </div>
                        ` : `
                            <div class="flex items-center justify-center h-[220px] text-gray-400 text-sm">
                                Sin gastos registrados
                            </div>
                        `}
                    </div>

                    <!-- Historial de Gastos -->
                    <div class="bg-white rounded-xl p-5 card animate-slide-in border border-gray-100">
                        <div class="flex justify-between items-center mb-3">
                            <h2 class="text-base font-semibold text-gray-800">üìù Historial</h2>
                            ${getFilteredExpenses().length > 0 ? `<span class="text-xs text-gray-400">${getFilteredExpenses().length} gastos</span>` : ''}
                        </div>
                        <div class="space-y-2 max-h-[200px] overflow-y-auto custom-scroll">
                            ${getFilteredExpenses().length === 0 ? `
                                <p class="text-gray-400 text-center py-8 text-sm">Sin gastos registrados</p>
                            ` : getFilteredExpenses().slice(0, 10).map(exp => `
                                <div class="expense-item flex items-center justify-between p-2.5 rounded-lg">
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2 mb-0.5">
                                            <span class="px-2 py-0.5 rounded-full text-xs font-medium ${categoryColors[exp.category]} truncate">
                                                ${exp.category.split(' ')[0]}
                                            </span>
                                            <span class="font-medium text-gray-800 text-sm truncate">${exp.description}</span>
                                        </div>
                                        <span class="text-xs text-gray-400">${exp.date}</span>
                                    </div>
                                    <div class="flex items-center gap-1 flex-shrink-0">
                                        <span class="font-semibold text-sm text-gray-800">${formatEuro(exp.amount)}</span>
                                        <button onclick="editExpense(${exp.id})" class="text-gray-400 hover:text-blue-500 transition p-1.5 hover:bg-blue-50 rounded-lg" title="Editar">‚úèÔ∏è</button>
                                        <button onclick="handleDeleteExpense(${exp.id})" class="text-gray-400 hover:text-red-500 transition p-1.5 hover:bg-red-50 rounded-lg" title="Eliminar">üóëÔ∏è</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        ${getFilteredExpenses().length > 0 ? `
                            <div class="mt-3 pt-3 border-t border-gray-100">
                                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                    <span class="text-sm font-medium text-gray-600">Total Gastos</span>
                                    <span class="amount-display-large text-blue-600">${formatEuro(monthTotal)}</span>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>

                <!-- Secciones Colapsables -->
                <div class="grid md:grid-cols-4 gap-4 mb-4">
                    <!-- Ahorros -->
                    <div class="bg-white rounded-xl p-5 card animate-slide-in-right border border-gray-100">
                        <button onclick="toggleSection('showSavingsSection')" class="w-full flex justify-between items-center mb-3">
                            <h2 class="text-base font-semibold text-gray-800">üí∏ Ahorros</h2>
                            <span id="showSavingsSectionBtn" class="toggle-btn text-lg ${state.showSavingsSection ? 'open' : ''}">‚ñº</span>
                        </button>
                        <div id="showSavingsSection" class="collapsible-content ${state.showSavingsSection ? 'open' : ''} custom-scroll">
                            <div class="mb-3 p-3 bg-emerald-50 rounded-lg">
                                <div class="flex justify-between text-xs text-gray-600 mb-1">
                                    <span>Por categor√≠a</span>
                                    <span class="font-semibold text-emerald-700">${formatEuro(typeTotals.ahorro)}</span>
                                </div>
                                <div class="flex justify-between text-xs text-gray-600 mb-1">
                                    <span>Ingresos extras</span>
                                    <span class="font-semibold text-emerald-700">+${formatEuro(getTotalDeposits())}</span>
                                </div>
                                <div class="flex justify-between text-xs text-gray-600 mb-2">
                                    <span>Retiros</span>
                                    <span class="font-semibold text-red-600">-${formatEuro(getTotalWithdrawals())}</span>
                                </div>
                                <div class="flex justify-between border-t border-emerald-200 pt-2">
                                    <span class="text-sm font-medium text-gray-700">Disponible</span>
                                    <span class="text-sm font-bold text-emerald-700">${formatEuro(getNetSavings())}</span>
                                </div>
                            </div>
                            
                            <div class="mb-3 p-3 bg-blue-50 rounded-lg">
                                <p class="text-xs font-semibold text-blue-700 mb-2">‚ûï A√±adir ingreso</p>
                                <div class="space-y-2">
                                    <input type="text" id="depositDescription" value="${state.depositDescription}" placeholder="Concepto" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" />
                                    <input type="number" id="depositAmount" value="${state.depositAmount}" placeholder="Cantidad" step="0.01" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" />
                                    <button onclick="addDeposit()" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white py-2 rounded-lg transition text-sm">+ Ingresar</button>
                                </div>
                            </div>
                            
                            <div class="mb-3 p-3 bg-red-50 rounded-lg">
                                <p class="text-xs font-semibold text-red-700 mb-2">‚ûñ Registrar retiro</p>
                                <div class="space-y-2">
                                    <input type="text" id="withdrawalDescription" value="${state.withdrawalDescription}" placeholder="Motivo" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" />
                                    <input type="number" id="withdrawalAmount" value="${state.withdrawalAmount}" placeholder="Cantidad" step="0.01" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" />
                                    <button onclick="addWithdrawal()" class="w-full bg-red-500 hover:bg-red-600 text-white py-2 rounded-lg transition text-sm">‚àí Retirar</button>
                                </div>
                            </div>
                            
                            ${(state.savingsDeposits.length > 0 || state.savingsWithdrawals.length > 0) ? `
                                <div class="space-y-2">
                                    <p class="text-xs font-semibold text-gray-500 uppercase">Historial</p>
                                    ${state.savingsDeposits.map(d => `
                                        <div class="flex justify-between items-center p-2 bg-emerald-50 rounded-lg">
                                            <div class="flex-1 min-w-0">
                                                <p class="font-medium text-xs text-gray-800 truncate">${d.description}</p>
                                                <p class="text-xs text-gray-400">${d.date}</p>
                                            </div>
                                            <div class="flex items-center gap-1">
                                                <span class="font-semibold text-emerald-600 text-sm">+${formatEuro(d.amount)}</span>
                                                <button onclick="handleDeleteDeposit(${d.id})" class="text-gray-400 hover:text-red-500 p-1">üóëÔ∏è</button>
                                            </div>
                                        </div>
                                    `).join('')}
                                    ${state.savingsWithdrawals.map(w => `
                                        <div class="flex justify-between items-center p-2 bg-red-50 rounded-lg">
                                            <div class="flex-1 min-w-0">
                                                <p class="font-medium text-xs text-gray-800 truncate">${w.description}</p>
                                                <p class="text-xs text-gray-400">${w.date}</p>
                                            </div>
                                            <div class="flex items-center gap-1">
                                                <span class="font-semibold text-red-600 text-sm">-${formatEuro(w.amount)}</span>
                                                <button onclick="handleDeleteWithdrawal(${w.id})" class="text-gray-400 hover:text-red-500 p-1">üóëÔ∏è</button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : '<p class="text-gray-400 text-xs text-center py-2">Sin movimientos</p>'}
                        </div>
                    </div>

                    <!-- Pr√©stamos -->
                    <div class="bg-white rounded-xl p-5 card animate-slide-in-right border border-gray-100" style="animation-delay: 0.05s;">
                        <button onclick="toggleSection('showLoansSection')" class="w-full flex justify-between items-center mb-3">
                            <h2 class="text-base font-semibold text-gray-800">üè¶ Pr√©stamos</h2>
                            <span id="showLoansSectionBtn" class="toggle-btn text-lg ${state.showLoansSection ? 'open' : ''}">‚ñº</span>
                        </button>
                        <div id="showLoansSection" class="collapsible-content ${state.showLoansSection ? 'open' : ''} custom-scroll">
                            <div class="mb-3 p-3 bg-orange-50 rounded-lg">
                                <div class="flex justify-between text-xs text-gray-600 mb-1">
                                    <span>Deuda total</span>
                                    <span class="font-semibold text-orange-700">${formatEuro(totalLoans)}</span>
                                </div>
                                <div class="flex justify-between border-t border-orange-200 pt-2">
                                    <span class="text-sm font-medium text-gray-700">Cuota mensual</span>
                                    <span class="text-sm font-bold text-orange-700">${formatEuro(monthlyLoanPayments)}</span>
                                </div>
                            </div>
                            <div class="space-y-2 mb-3">
                                <input type="text" id="loanName" value="${state.loanName}" placeholder="Nombre pr√©stamo" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" />
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="number" id="loanAmount" value="${state.loanAmount}" placeholder="Capital" step="0.01" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" />
                                    <input type="number" id="loanMonths" value="${state.loanMonths}" placeholder="Meses" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" />
                                </div>
                                <input type="number" id="loanPaid" value="${state.loanPaid}" placeholder="Ya pagado (opcional)" step="0.01" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" />
                                <div>
                                    <label class="text-xs text-gray-500 mb-1 block">1¬™ cuota</label>
                                    <input type="month" id="loanStartDate" value="${state.loanStartDate}" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" />
                                </div>
                                <button onclick="addLoan()" class="w-full bg-orange-500 hover:bg-orange-600 text-white py-2 rounded-lg transition text-sm">+ A√±adir</button>
                            </div>
                            ${state.loans.length > 0 ? `
                                <div class="space-y-3">
                                    ${state.loans.map(l => {
                                        const active = isLoanActive(l);
                                        return `
                                        <div class="p-3 ${active ? 'bg-orange-50 border-orange-200' : 'bg-gray-50 border-gray-200'} rounded-lg border">
                                            <div class="flex justify-between items-start mb-2">
                                                <div class="flex-1 min-w-0">
                                                    <p class="font-semibold text-sm text-gray-800 truncate">${l.name}</p>
                                                    <p class="text-xs text-gray-500">${l.remainingMonths} meses</p>
                                                </div>
                                                <button onclick="handleDeleteLoan(${l.id})" class="text-gray-400 hover:text-red-500 p-1">üóëÔ∏è</button>
                                            </div>
                                            <div class="flex justify-between text-xs mb-2">
                                                <span class="text-gray-500">Pendiente</span>
                                                <span class="font-bold text-orange-700">${formatEuro(l.pendingAmount)}</span>
                                            </div>
                                            <div class="w-full bg-gray-200 rounded-full h-1.5 mb-2">
                                                <div class="${active ? 'bg-orange-500' : 'bg-gray-400'} h-1.5 rounded-full" style="width: ${(l.paidAmount / l.totalAmount) * 100}%"></div>
                                            </div>
                                            <button onclick="payLoan(${l.id})" class="w-full ${active ? 'bg-emerald-500 hover:bg-emerald-600' : 'bg-gray-400'} text-white py-1.5 rounded text-xs transition" ${!active ? 'disabled' : ''}>
                                                ‚úì Pagar ${formatEuro(l.monthlyPayment)}
                                            </button>
                                        </div>
                                    `}).join('')}
                                </div>
                            ` : '<p class="text-gray-400 text-xs text-center py-3">Sin pr√©stamos</p>'}
                        </div>
                    </div>

                    <!-- Me Deben -->
                    <div class="bg-white rounded-xl p-5 card animate-slide-in-right border border-gray-100" style="animation-delay: 0.1s;">
                        <button onclick="toggleSection('showDebtorsSection')" class="w-full flex justify-between items-center mb-3">
                            <h2 class="text-base font-semibold text-gray-800">üíµ Me Deben</h2>
                            <span id="showDebtorsSectionBtn" class="toggle-btn text-lg ${state.showDebtorsSection ? 'open' : ''}">‚ñº</span>
                        </button>
                        <div id="showDebtorsSection" class="collapsible-content ${state.showDebtorsSection ? 'open' : ''} custom-scroll">
                            <div class="mb-3 p-3 bg-blue-50 rounded-lg text-center">
                                <p class="text-xs text-gray-500 mb-1">Total pendiente</p>
                                <p class="text-xl font-bold text-blue-600">${formatEuro(getTotalOwed())}</p>
                            </div>
                            <div class="space-y-2 mb-3">
                                <input type="text" id="debtorName" value="${state.debtorName}" placeholder="Nombre" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" />
                                <input type="number" id="debtorAmount" value="${state.debtorAmount}" placeholder="Cantidad" step="0.01" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" />
                                <button onclick="addDebtor()" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg transition text-sm">+ A√±adir</button>
                            </div>
                            ${state.debtors.length > 0 ? `
                                <div class="space-y-2">
                                    ${state.debtors.map(d => `
                                        <div class="flex justify-between items-center p-2 bg-blue-50 rounded-lg">
                                            <div class="flex-1 min-w-0">
                                                <p class="font-medium text-xs text-gray-800 truncate">${d.name}</p>
                                                <p class="text-xs text-gray-400">${d.date}</p>
                                            </div>
                                            <div class="flex items-center gap-1">
                                                <span class="font-semibold text-blue-600 text-sm">${formatEuro(d.amount)}</span>
                                                <button onclick="remindDebtorWhatsApp('${d.name}', ${d.amount})" class="text-gray-400 hover:text-green-500 p-1" title="WhatsApp">üì±</button>
                                                <button onclick="handleDeleteDebtor(${d.id})" class="text-gray-400 hover:text-red-500 p-1">üóëÔ∏è</button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : '<p class="text-gray-400 text-xs text-center py-3">Sin deudas</p>'}
                        </div>
                    </div>

                    <!-- Proyecciones -->
                    <div class="bg-white rounded-xl p-5 card animate-slide-in-right border border-gray-100" style="animation-delay: 0.15s;">
                        <button onclick="toggleSection('showProjectionsSection')" class="w-full flex justify-between items-center mb-3">
                            <h2 class="text-base font-semibold text-gray-800">üìà Proyecciones</h2>
                            <span id="showProjectionsSectionBtn" class="toggle-btn text-lg ${state.showProjectionsSection ? 'open' : ''}">‚ñº</span>
                        </button>
                        <div id="showProjectionsSection" class="collapsible-content ${state.showProjectionsSection ? 'open' : ''} custom-scroll">
                            <div class="space-y-2 mb-3">
                                <input type="number" id="projectionMonths" value="${state.projectionMonths}" placeholder="Meses" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" />
                                <input type="number" id="monthlySavingsPlan" value="${state.monthlySavingsPlan}" placeholder="Ahorro mensual" step="0.01" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm" />
                            </div>
                            ${state.projectionMonths && state.monthlySavingsPlan ? `
                                <div class="grid grid-cols-2 gap-2">
                                    <div class="bg-blue-50 p-3 rounded-lg">
                                        <p class="text-xs text-blue-600 mb-1">Desde cero</p>
                                        <p class="text-sm font-bold text-blue-800">${formatEuro(projections.fromZero)}</p>
                                    </div>
                                    <div class="bg-emerald-50 p-3 rounded-lg">
                                        <p class="text-xs text-emerald-600 mb-1">Con actual</p>
                                        <p class="text-sm font-bold text-emerald-800">${formatEuro(projections.withCurrent)}</p>
                                    </div>
                                    <div class="bg-violet-50 p-3 rounded-lg">
                                        <p class="text-xs text-violet-600 mb-1">Sin prestado</p>
                                        <p class="text-sm font-bold text-violet-800">${formatEuro(projections.withoutOwed)}</p>
                                    </div>
                                    <div class="bg-amber-50 p-3 rounded-lg">
                                        <p class="text-xs text-amber-600 mb-1">Si pagan</p>
                                        <p class="text-sm font-bold text-amber-800">${formatEuro(projections.withOwed)}</p>
                                    </div>
                                </div>
                            ` : '<p class="text-gray-400 text-xs text-center py-3">Completa los campos</p>'}
                        </div>
                    </div>
                </div>

                <!-- Bot√≥n Reset -->
                <div class="pt-4 border-t border-gray-200">
                    <button onclick="resetMonth()" class="w-full bg-gray-100 hover:bg-red-50 text-gray-500 hover:text-red-600 py-3 rounded-xl transition text-sm font-medium border border-gray-200 hover:border-red-200">
                        üîÑ Reset (nuevo mes)
                    </button>
                </div>
            `;

            // Event listeners
            ['monthlyIncome', 'creditCardIncome'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', (e) => { state[id] = e.target.value; updateTotalsOnly(); });
            });

            ['projectionMonths', 'monthlySavingsPlan'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', (e) => { state[id] = e.target.value; render(); });
            });

            ['description', 'amount', 'withdrawalDescription', 'withdrawalAmount', 'depositDescription', 'depositAmount', 'debtorName', 'debtorAmount', 'loanName', 'loanAmount', 'loanMonths', 'loanPaid', 'loanStartDate'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', (e) => state[id] = e.target.value);
            });

            const categoryEl = document.getElementById('category');
            if (categoryEl) categoryEl.addEventListener('change', (e) => state.category = e.target.value);

            const dateEl = document.getElementById('date');
            if (dateEl) dateEl.addEventListener('change', (e) => state.date = e.target.value);

            setTimeout(() => renderChart(), 100);
        }

        function handleDeleteExpense(id) { if (confirm('¬øEliminar este gasto?')) deleteExpense(id); }
        function handleDeleteWithdrawal(id) { if (confirm('¬øEliminar este retiro?')) deleteWithdrawal(id); }
        function handleDeleteDeposit(id) { if (confirm('¬øEliminar este ingreso?')) deleteDeposit(id); }
        function handleDeleteDebtor(id) { if (confirm('¬øEliminar este deudor?')) deleteDebtor(id); }
        function handleDeleteLoan(id) { if (confirm('¬øEliminar este pr√©stamo?')) deleteLoan(id); }

        // ========== FUNCIONES DE MODAL ==========
        function showExpensesByType(type, title) {
            const filtered = getFilteredExpenses().filter(exp => getCategoryType(exp.category) === type);
            const total = filtered.reduce((sum, exp) => sum + exp.amount, 0);
            
            let content = filtered.length === 0 ? '<p class="text-gray-400 text-center py-8">No hay gastos</p>' : `
                <div class="mb-4 p-3 bg-gray-50 rounded-lg flex justify-between items-center">
                    <span class="text-sm text-gray-600">${filtered.length} gasto${filtered.length !== 1 ? 's' : ''}</span>
                    <span class="font-bold text-gray-800">${formatEuro(total)}</span>
                </div>
                <div class="space-y-2">
                    ${filtered.map(exp => `
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <div class="flex-1 min-w-0">
                                <p class="font-medium text-sm text-gray-800 truncate">${exp.description}</p>
                                <p class="text-xs text-gray-400">${exp.category} ‚Ä¢ ${exp.date}</p>
                            </div>
                            <span class="font-semibold text-gray-800 ml-3">${formatEuro(exp.amount)}</span>
                        </div>
                    `).join('')}
                </div>
            `;
            
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('detailModal').classList.remove('hidden');
        }

        function showSavingsDetail() {
            const savingsExpenses = getFilteredExpenses().filter(exp => getCategoryType(exp.category) === 'ahorro');
            const totalFromExpenses = savingsExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            
            let content = `
                <div class="space-y-3 mb-4">
                    <div class="p-3 bg-emerald-50 rounded-lg flex justify-between items-center">
                        <span class="text-sm text-emerald-700">Por categor√≠as</span>
                        <span class="font-bold text-emerald-800">${formatEuro(totalFromExpenses)}</span>
                    </div>
                    <div class="p-3 bg-blue-50 rounded-lg flex justify-between items-center">
                        <span class="text-sm text-blue-700">Ingresos extras</span>
                        <span class="font-bold text-blue-800">+${formatEuro(getTotalDeposits())}</span>
                    </div>
                    <div class="p-3 bg-red-50 rounded-lg flex justify-between items-center">
                        <span class="text-sm text-red-700">Retiros</span>
                        <span class="font-bold text-red-800">-${formatEuro(getTotalWithdrawals())}</span>
                    </div>
                    <div class="p-3 bg-gray-100 rounded-lg flex justify-between items-center border-t-2 border-emerald-500">
                        <span class="text-sm font-semibold text-gray-700">Ahorro Neto</span>
                        <span class="font-bold text-emerald-700">${formatEuro(getNetSavings())}</span>
                    </div>
                </div>
            `;
            
            document.getElementById('modalTitle').textContent = 'Ahorro Neto';
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('detailModal').classList.remove('hidden');
        }

        function showLoansDetail() {
            const activeLoans = state.loans.filter(l => l.pendingAmount > 0);
            
            let content = activeLoans.length === 0 ? '<p class="text-gray-400 text-center py-8">No hay pr√©stamos</p>' : `
                <div class="space-y-3 mb-4">
                    <div class="p-3 bg-orange-50 rounded-lg flex justify-between items-center">
                        <span class="text-sm text-orange-700">Deuda total</span>
                        <span class="font-bold text-orange-800">${formatEuro(getTotalLoans())}</span>
                    </div>
                    <div class="p-3 bg-gray-100 rounded-lg flex justify-between items-center">
                        <span class="text-sm text-gray-700">Cuota mensual</span>
                        <span class="font-bold text-gray-800">${formatEuro(getTotalMonthlyLoanPayments())}</span>
                    </div>
                </div>
                <div class="space-y-2">
                    ${activeLoans.map(l => `
                        <div class="p-3 bg-orange-50 rounded-lg">
                            <p class="font-medium text-sm text-gray-800">${l.name}</p>
                            <div class="flex justify-between text-xs mt-1">
                                <span class="text-gray-500">Pendiente: ${formatEuro(l.pendingAmount)}</span>
                                <span class="text-gray-500">Cuota: ${formatEuro(l.monthlyPayment)}</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            document.getElementById('modalTitle').textContent = 'Pr√©stamos';
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('detailModal').classList.remove('hidden');
        }

        function closeDetailModal(event) {
            if (!event || event.target.id === 'detailModal') {
                document.getElementById('detailModal').classList.add('hidden');
            }
        }

        function resetMonth() {
            if (!confirm('‚ö†Ô∏è ¬øEst√°s seguro?\n\nSe borrar√°n:\n‚Ä¢ Todos los gastos\n‚Ä¢ Ingresos del mes\n‚Ä¢ Donaciones\n\nSe mantendr√°n:\n‚Ä¢ Ahorros\n‚Ä¢ Pr√©stamos\n‚Ä¢ Deudores\n‚Ä¢ Proyecciones')) return;

            if (supabaseClient) {
                state.expenses.forEach(exp => deleteFromSupabase('expenses', exp.id));
            }

            state.expenses = [];
            state.monthlyIncome = '';
            state.creditCardIncome = '';

            saveDataLocal();
            render();
            showNotification('üîÑ Mes reiniciado correctamente');
        }

        window.ExpenseTracker = { initSupabase, getState: () => state, saveData, exportData };

        async function autoInit() {
            // Cargar datos locales primero
            const savedData = localStorage.getItem('expenseTrackerData');
            if (savedData) {
                const data = JSON.parse(savedData);
                Object.assign(state, {
                    expenses: data.expenses || [],
                    savingsWithdrawals: data.savingsWithdrawals || [],
                    savingsDeposits: data.savingsDeposits || [],
                    debtors: data.debtors || [],
                    loans: data.loans || [],
                    monthlyIncome: data.monthlyIncome || '',
                    creditCardIncome: data.creditCardIncome || '',
                    projectionMonths: data.projectionMonths || '',
                    monthlySavingsPlan: data.monthlySavingsPlan || '',
                    darkMode: data.darkMode || false,
                    badges: data.badges || [],
                    lastMonthSavings: data.lastMonthSavings || 0
                });
                syncQueue = data.syncQueue || [];
            }
            document.body.classList.toggle('dark-mode', state.darkMode);
            
            // Inicializar Supabase
            if (SUPABASE_CONFIG.url && SUPABASE_CONFIG.anonKey) {
                try {
                    if (!window.supabase) await loadScript('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2');
                    
                    supabaseClient = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
                    SUPABASE_CONFIG.initialized = true;
                    isOnline = true;
                    
                    // Verificar sesi√≥n existente
                    const { data: { session } } = await supabaseClient.auth.getSession();
                    
                    if (session && session.user) {
                        // Usuario autenticado
                        authState.isAuthenticated = true;
                        authState.user = session.user;
                        authState.loading = false;
                        currentUser = session.user;
                        state.userId = session.user.id;
                        
                        // Cargar datos del usuario desde Supabase
                        await loadDataFromSupabasePublic();
                        checkBadges();
                        render();
                        setTimeout(() => showMotivationMessages(), 1500);
                        showNotification('‚úÖ Conectado');
                    } else {
                        // No hay sesi√≥n, mostrar login
                        authState.isAuthenticated = false;
                        authState.loading = false;
                        renderAuth();
                    }
                    
                    // Escuchar cambios en la autenticaci√≥n
                    supabaseClient.auth.onAuthStateChange(async (event, session) => {
                        if (event === 'SIGNED_IN' && session) {
                            authState.isAuthenticated = true;
                            authState.user = session.user;
                            currentUser = session.user;
                            state.userId = session.user.id;
                            await loadDataFromSupabasePublic();
                            checkBadges();
                            render();
                        } else if (event === 'SIGNED_OUT') {
                            authState.isAuthenticated = false;
                            authState.user = null;
                            currentUser = null;
                            state.userId = null;
                            renderAuth();
                        }
                    });
                    
                } catch (error) {
                    console.error('Error auto-init:', error);
                    isOnline = false;
                    authState.loading = false;
                    // Si falla Supabase, mostrar login de todas formas
                    renderAuth();
                }
            } else {
                authState.loading = false;
                renderAuth();
            }
        }

        async function loadDataFromSupabasePublic() {
            if (!supabaseClient || !state.userId) return;
            
            try {
                // Cargar gastos del usuario
                const { data: expenses } = await supabaseClient
                    .from('expenses')
                    .select('*')
                    .eq('user_id', state.userId)
                    .order('date', { ascending: false });
                if (expenses) state.expenses = expenses;
                
                // Cargar retiros del usuario
                const { data: withdrawals } = await supabaseClient
                    .from('savings_withdrawals')
                    .select('*')
                    .eq('user_id', state.userId)
                    .order('date', { ascending: false });
                if (withdrawals) state.savingsWithdrawals = withdrawals;

                // Cargar dep√≥sitos del usuario
                const { data: deposits } = await supabaseClient
                    .from('savings_deposits')
                    .select('*')
                    .eq('user_id', state.userId)
                    .order('date', { ascending: false });
                if (deposits) state.savingsDeposits = deposits;
                
                // Cargar deudores del usuario
                const { data: debtors } = await supabaseClient
                    .from('debtors')
                    .select('*')
                    .eq('user_id', state.userId)
                    .order('date', { ascending: false });
                if (debtors) state.debtors = debtors;

                // Cargar pr√©stamos del usuario
                const { data: loans } = await supabaseClient
                    .from('loans')
                    .select('*')
                    .eq('user_id', state.userId)
                    .order('date', { ascending: false });
                if (loans) {
                    state.loans = loans.map(l => ({
                        id: l.id, name: l.name, totalAmount: l.total_amount, pendingAmount: l.pending_amount,
                        paidAmount: l.paid_amount, totalMonths: l.total_months, remainingMonths: l.remaining_months,
                        monthlyPayment: l.monthly_payment, startDate: l.start_date || l.date?.slice(0, 7), date: l.date
                    }));
                }
                
                // Cargar configuraci√≥n del usuario
                const { data: config } = await supabaseClient
                    .from('user_config')
                    .select('*')
                    .eq('user_id', state.userId)
                    .single();
                if (config) {
                    state.monthlyIncome = config.monthly_income || '';
                    state.creditCardIncome = config.credit_card_income || '';
                    state.projectionMonths = config.projection_months || '';
                    state.monthlySavingsPlan = config.monthly_savings_plan || '';
                    state.darkMode = config.dark_mode || false;
                    state.badges = config.badges || [];
                }
                
                state.lastSync = new Date().toISOString();
                checkBadges();
            } catch (error) {
                console.error('Error cargando datos:', error);
            }
        }

        autoInit();
    </script>

</body>
</html>
